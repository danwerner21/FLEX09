0001                           OPT      PAG
0002                           TTL      6809 FILE MANAGEMENT SYSTEM
0003                           PAG
0004                 *
0005                 * TSC 6809 DISK FILE MANAGEMENT SYSTEM
0006                 *
0007                 * COPYRIGHT (C) 1979 BY
0008                 *
0009                 * TECHNICAL SYSTEMS CONSULTANTS, INC.
0010                 * BOX 2574
0011                 * WEST LAFAYETTE, INDIANA 47906
0012                 * (317) 463-2502
0013                 *
0014                 * NOTE:
0015                 * AS OF 11/79 THE POINTS IN FMS WHICH LOAD A REGISTER
0016                 * WITH THE SECTOR LENGTH HAVE BEEN CHANGED TO SIMPLY
0017                 * CLEAR THE REGISTER (SINCE LDB #256 = LDB #0).
0018                 * ALL POINTS AFFECTED BY THIS CHANGE ARE FLAGGED WITH
0019                 * FOUR BACKSLASHES IN THE COMMENT FIELD (\\\\).
0020                 *
0021                 * CORRECTED WRITE FILE SECTOR MAP ROUTINE (WTFSM) 2/4/80.
0022                 
0023                 *
0024                 * THE FILE MANAGEMENT SYSTEM (FMS) RELIES
0025                 * ON THE USER DEFINITIONS OF FILE CONTROL
0026                 * BLOCKS (FCB) FOR EACH FILE OPENED.
0027                 * THE FCB STRUCTURE IS AS FOLLOWS:
0028                 *
0029                 * EACH FCB CONSUMES 320 BYTES OF RAM.
0030                 * EACH BYTE IS USED AS FOLLOWS:
0031                 *
0032                 * NAME  OFFSET FUNCTION
0033                 * ----  ------ --------
0034                 
0035 0000            FFC       EQU      0         FUNCTION OP CODE
0036 0001            FES       EQU      1         ERROR STATUS BYTE
0037 0002            FAS       EQU      2         ACTIVITY STATUS
0038 0003            FDN       EQU      3         DRIVE NUMBER
0039 0004            FFN       EQU      4         - 11 FILE NAME
0040 000C            FNE       EQU      12        - 14 NAME EXTENSION
0041 000F            FID       EQU      15        IDENTIFIER BYTE
0042 0010            FNU       EQU      16        FILE NUMBER
0043 0011            FSA       EQU      17        - 18 START DISK ADR.
0044 0013            FEA       EQU      19        - 20 END DISK ADDRESS
0045 0015            FSZ       EQU      21        - 22 FILE SIZE
0046 0017            FMP       EQU      23        - 24 FILE SECTOR MAP
0047 0019            FDT       EQU      25        - 27 CREATION DATE
0048 001C            FLP       EQU      28        - 29 FCB LIST POINTER
0049 001E            FCS       EQU      30        - 31 CURRENT SECTOR
0050 0020            FRN       EQU      32        - 33 RECORD NUMBER
0051 0022            FDI       EQU      34        DATA INDEX
0052 0023            FRI       EQU      35        RANDOM INDEX
0053 0024            FWB       EQU      36        - 46 NAME WORK BUFFER
0054 002F            FCD       EQU      47        - 49 CURRENT DIR. ADR.
0055 0032            FFD       EQU      50        - 52 FIRST DELETED DIR.
0056 0035            FLR       EQU      53        - 55 LAST RECORD PNTR
0057 0038            FNK       EQU      56        - 58 NEXT KEY POINTER
0058 003B            FSC       EQU      59        SPACE COMP. CNTR
0059 003C            FSP       EQU      60        - 63 SPARE BYTES
0060 0040            FSB       EQU      64        - 319 SECTOR BUFFER
0061                 
0062 003C            FMX       EQU      FSP       MAX SECTOR NUMBER
0063 0037            SBC       EQU      FLR+2     SEQ. BLOCK COUNT
0064                 
0065                 *
0066                 * ALL DRIVER ROUTINES ARE REFERENCED
0067                 * THROUGH THIS TABLE.
0068                 
0069 DE00            DREAD     EQU      $DE00     DISK READ ROUTINE
0070 DE03            DWRITE    EQU      $DE03     DISK WRITE ROUTINE
0071 DE09            RESTOR    EQU      $DE09     HEAD RESTORE ROUTINE
0072 DE06            VERIFY    EQU      $DE06     WRITE VERIFY ROUTINE
0073 DE0C            DRIVE     EQU      $DE0C     DRIVE SELECT
0074 DE0F            CHECK     EQU      $DE0F     CHECK READY
0075 DE12            QUKCHK    EQU      $DE12     QUICK READY CHECK
0076 DE15            DINIT     EQU      $DE15     INITIALIZE DRIVERS
0077 DE18            DWARM     EQU      $DE18     USER WARMSTART ROUTINE
0078 DE1B            DSEEK     EQU      $DE1B     SEEK TO TRACK ROUTINE
0079                 
0080                 * ALL LOW LEVEL SYSTEM VARIABLES
0081                 * AND CONSTANTS ARE IN THIS AREA.
0082                 *
0083                 * SYSTEM CONSTANTS
0084                 
0085 0100            SL        EQU      256       SECTOR LENGTH
0086 000B            NL        EQU      11        NAME LENGTH
0087 0005            RTC       EQU      5         RETRY COUNT
0088 0007            RSC       EQU      7         SEEK RETRY COUNT
0089 0004            RS        EQU      4         RECORD START
0090 0010            IRS       EQU      16        INFO RECORD START
0091 0018            IRL       EQU      24        INFO RECORD LENGTH
0092 0004            IRFAS     EQU      $04       INFO MASK
0093 0016            LSTFC     EQU      22        LAST FUNCTION CODE
0094 007F            MAXSP     EQU      $7F       MAX SPACE COUNT
0095 0020            SPC       EQU      $20       ASCII SPACE
0096 0009            SCC       EQU      9         SPACE COMPRESSION CHAR.
0097 0018            DELC      EQU      $18       DELETE CHARACTER
0098 0004            NODR      EQU      4         NUMBER OF DRIVES
0099 0000            DTRK      EQU      0         DIRECTORY START TRACK
0100 0005            DSEC      EQU      5         DIR. START SECTOR
0101 0003            ISEC      EQU      3         INFO SECTOR NUMBER
0102 007F            TRMSK     EQU      $7F       TRACK MASK
0103 007F            SCMSK     EQU      $7F       SECTOR MASK
0104 004C            LSTTRK    EQU      76        LAST TRACK NUMBER
0105 000F            LSTSEC    EQU      15        LAST SECTOR NUMBER
0106 0010            RNFMSK    EQU      $10       REC NOT FOUND MASK
0107 0005            MAIND     EQU      $0005     MAIN DIRECTORY ADDRESS
0108                 
0109                 * DOS CONSTANTS
0110                 
0111 CC0E            DATE      EQU      $CC0E     SYSTEM DATA
0112 C709            LOCK      EQU      $C709     LOCK FMS
0113 C70C            UNLOCK    EQU      $C70C     UNLOCK FMS
0114 CCFC            PR1       EQU      $CCFC     PROCESS 1 REGISTER
0115                 
0116                 * SYSTEM ERROR NUMBER DEFINITIONS
0117                 *
0118                 * NAME  NUMBER MEANING
0119                 * ----  ------ -------
0120                 
0121 0000            NOER      EQU      0         NO ERROR
0122 0001            ICER      EQU      1         ILLEGAL FUNCTION CODE
0123 0002            FBER      EQU      2         FILE BUSY
0124 0003            FEER      EQU      3         FILE EXISTS
0125 0004            NFER      EQU      4         NO SUCH FILE
0126 0005            DRER      EQU      5         DIRECTORY ERROR
0127 0006            TMER      EQU      6         TOO MANY FILES
0128 0007            DFER      EQU      7         DISK FULL
0129 0008            EFER      EQU      8         END OF FILE
0130 0009            RDER      EQU      9         READ ERROR (CRC)
0131 000A            WTER      EQU      10        WRITE ERROR (CRC)
0132 000B            WPER      EQU      11        WRITE PROTECTED
0133 000C            DPER      EQU      12        DELETE PROTECTED
0134 000D            IFER      EQU      13        ILLEGAL FCB
0135 000E            DAER      EQU      14        ILLEGAL DISK ADDRESS
0136 000F            DNER      EQU      15        DRIVE NUMBER ERROR
0137 0010            NRER      EQU      16        NOT READY
0138 0011            ADER      EQU      17        ACCESS DENIED
0139 0012            STER      EQU      18        STATUS ERROR
0140 0013            IRER      EQU      19        INDEX RANGE ERROR
0141 0014            FIER      EQU      20        FMS INACTIVE
0142 0015            INER      EQU      21        ILLEGAL FILE NAME
0143 0016            CLER      EQU      22        CLOSE ERROR
0144 0017            FSER      EQU      23        FSM OVERFLOW ERROR
0145 0018            RRER      EQU      24        RECORD RANGE ERROR
0146 0019            RMER      EQU      25        RECORD MATCH ERROR
0147                 
0148 D400                      ORG      $D400
0149                 
0150                 * FMS JUMP TABLES
0151                 *
0152                 * ALL CALLS TO THE FMS SHOULD ENTER
0153                 * THROUGH ONE OF THESE THREE POINTS.
0154                 
0155 D400 7ED43A     FMSINT    JMP      INIT      FMS INITIALIZATION  $D400
0156 D403 7ED45D     FMSCLS    JMP      EXCLS     FMS CLOSURE         $D403
0157 D406 7ED47F     FMS       JMP      CMND      FMS COMMAND ENTRY   $D406
0158                 
0159                 * GLOBAL VARIABLE STORAGE
0160                 
0161 D409            FCBBAS    RMB      2         FCB BASE POINTER        $D409
0162 D40B            FCBSTR    RMB      2         CURRENT FCB             $D40B
0163 D40D            TEMP      RMB      2         TEMPORARY INDEX         $D40D
0164 D40F            DATAPT    RMB      2         DATA POINTER            $D40F
0165 D411            ETRIES    RMB      1         ERROR TRY COUNT         $D411
0166 D412            STRIES    RMB      1         SEEK TRY COUNT          $D412
0167 D413            CLD       RMB      2         CURRENT LOOK UP DIR     $D413
0168 D415            CUD       RMB      2         CURRENT USER DIR        $D415
0169 D417            DIRDN     RMB      1         DIRECTORY DRIVE NUM     $D417
0170 D418            BKLN      RMB      2         BACK LINK               $D418
0171 D41A            SINDIR    RMB      1         SINGLE DIR SEARCH       $D41A
0172 D41B            AVLPNT    RMB      2         AVAIL POINTER           $D41B
0173 D41D            SECMAP    RMB      NODR*6    SECTOR MAPS             $D41D
0174                 
0175 D435                      ORG      $D435
0176                 
0177 D435 FF         VRFYFG    FCB      $FF       VERIFY FLAG
0178                 
0179 D436 00000000   DRVINFO   FCB      $00,$00,$00,$00
0180                 
0181                 * SYSTEM ENTRY ROUTINES
0182                 *
0183                 * THE FOLLOWING THREE ROUTINES SHOULD
0184                 * BE ACCESSED THROUGH THE SYSTEM JUMP
0185                 * TABLE.
0186                 
0187                 * INIT
0188                 *
0189                 * INIT IS THE FMS INITIALIZATION ROUTINE.
0190                 * NO ERRORS CAN OCCUR FROM THIS ROUTINE
0191                 * AND THE SYSTEM ASSUMES NO FILES ARE OPEN.
0192                 
0193 D43A BDDE15     INIT      JSR      DINIT     INITIALIZE DRIVERS
0194 D43D 8ED409               LDX      #FCBBAS   SET POINTER
0195 D440 C60A                 LDB      #10       SET COUNT
0196 D442 8D11                 BSR      INIT4     CLEAR SPACE
0197 D444 8E0005               LDX      #MAIND    SET MAIN DIRECTORY
0198 D447 BFD413               STX      CLD
0199 D44A BFD415               STX      CUD
0200 D44D 7FD41A               CLR      SINDIR    CLEAR SINGLE DIR
0201                 
0202 D450 8ED41B     INIT2     LDX      #AVLPNT   POINT TO FMS SPC
0203 D453 C61A                 LDB      #26       SET COUNTER
0204                 
0205 D455 6F80       INIT4     CLR      0,X+      CLEAR BYTE
0206 D457 5A                   DECB               DEC THE COUNT
0207 D458 26FB                 BNE      INIT4     REPEAT?
0208 D45A 7EC70C               JMP      UNLOCK
0209                 
0210                 * EXCLS
0211                 *
0212                 * EXCLS IS THE FMS EXIT ROUTINE.
0213                 * EXECUTION OF THIS ROUTINE TELLS THE
0214                 * SYSTEM TO CLOSE ALL OPEN FILES.
0215                 
0216 D45D BDC709     EXCLS     JSR      LOCK      LOCK FMS
0217 D460 BED409     EXCLS1    LDX      FCBBAS    GET LINK BASE
0218 D463 27EB                 BEQ      INIT2     ANY FCBS LEFT?
0219 D465 3088E4               LEAX     -FLP,X
0220 D468 BFD40B               STX      FCBSTR    SET ACT. FCB
0221 D46B 3420                 PSHS     Y         SAVE REGISTER
0222 D46D BDDADA               JSR      CLOSE     GO CLOSE FILE
0223 D470 3520                 PULS     Y         RESTORE REGISTER
0224 D472 24EC                 BCC      EXCLS1    REPEAT
0225                 
0226 D474 BED40B               LDX      FCBSTR    SET TO FCB
0227 D477 6F02                 CLR      2,X       CLEAR FAS
0228 D479 BDC70C               JSR      UNLOCK    UNLOCK FMS
0229 D47C C6FF                 LDB      #$FF      SET ERROR
0230 D47E 39                   RTS
0231                 
0232                 * CMND
0233                 *
0234                 * CMND IS THE FMS COMMAND INTERPRETER.
0235                 * ALL COMMAND CALLS TO FMS SHOULD BE
0236                 * THROUGH THIS ROUTINE.
0237                 
0238 D47F 7DCCFC     CMND      TST      PR1       PROCESS ACTIVE?
0239 D482 2703                 BEQ      CMND1
0240 D484 BDC709               JSR      LOCK      LOCK FMS
0241                 
0242 D487 3424       CMND1     PSHS     B,Y       SAVE REGISTERS
0243 D489 BFD40B               STX      FCBSTR    SET FCB STORAGE
0244 D48C 6F01                 CLR      FES,X     CLEAR ERRORS
0245 D48E E684                 LDB      FFC,X     GET FUNCTION CODE
0246 D490 2622                 BNE      CMND4     IO CODE?
0247                 
0248 D492 E602                 LDB      FAS,X     GET ACTIVITY BYTE
0249 D494 271A                 BEQ      CMND3
0250                 
0251 D496 C102                 CMPB     #2        IS IT WRITE?
0252 D498 2711                 BEQ      CMND2
0253 D49A BDD5BC               JSR      SRDSEQ    GO DO READ
0254 D49D BED40B     CMND15    LDX      FCBSTR    RESTORE X
0255 D4A0 2526                 BCS      CMND7     ERROR?
0256 D4A2 7DCCFC               TST      PR1       PR 1 ACTIVE?
0257 D4A5 2623                 BNE      CMND8
0258 D4A7 5F                   CLRB               CLEAR ERRORS
0259 D4A8 3524                 PULS     B,Y       RESTORE REGISTERS
0260 D4AA 39                   RTS
0261                 
0262 D4AB BDD6D7     CMND2     JSR      SWTSEQ    GO DO WRITE
0263 D4AE 20ED                 BRA      CMND15
0264                 
0265 D4B0 C612       CMND3     LDB      #STER     SET STATUS ERROR
0266 D4B2 2014                 BRA      CMND7     REPORT ERROR
0267                 
0268 D4B4 C116       CMND4     CMPB     #LSTFC    CHECK CODE
0269 D4B6 2304                 BLS      CMND5
0270 D4B8 C601                 LDB      #ICER     SET CODE ERROR
0271 D4BA 200C                 BRA      CMND7     REPORT IT
0272                 
0273 D4BC 5A         CMND5     DECB               DEC THE CODE
0274 D4BD 58                   ASLB               CODE TIMES 2
0275 D4BE 8ED4D2               LDX      #CODTBL   POINT TO TABLE
0276 D4C1 AD95                 JSR      [B,X]     GO DO ROUTINE
0277 D4C3 BED40B               LDX      FCBSTR    RESTORE FCB PNTR
0278 D4C6 2402                 BCC      CMND8     ERRORS?
0279                 
0280 D4C8 E701       CMND7     STB      FES,X     SET ERROR
0281                 
0282 D4CA BDC70C     CMND8     JSR      UNLOCK
0283 D4CD 6D01                 TST      FES,X     TEST FOR ERROR
0284 D4CF 3524                 PULS     B,Y       RESTORE REGISTERS
0285 D4D1 39                   RTS
0286                 
0287                 * CODTBL
0288                 *
0289                 * CODTBL IS THE SYSTEM TABLE OF
0290                 * FUNCTION CODE ROUTINE ADDRESSES.
0291                 
0292 D4D2 D98F       CODTBL    FDB      OPNRD     OPNRD   OPEN FOR READ
0293 D4D4 D9E2                 FDB      OPNWT     OPNWT   OPEN FOR WRITE
0294 D4D6 DB10                 FDB      OPNRW     OPNRW   OPEN FOR READ WRITE
0295 D4D8 DADA                 FDB      CLOSE     CLOSE   CLOSE FILE
0296 D4DA D5EA                 FDB      REWIND    REWIND  REWIND FILE
0297 D4DC D825                 FDB      OPNDIR    OPNDIR  OPEN DIRECTORY
0298 D4DE D840                 FDB      GETIR     GETIR   GET INFO RECORD
0299 D4E0 D87F                 FDB      PUTIR     PUTIR   PUT INFO RECORD
0300 D4E2 D649                 FDB      READSS    READSS  READ SINGLE SECTOR
0301 D4E4 D6A7                 FDB      WRITSS    WRITSS  WRITE SINGLE SECTOR
0302 D4E6 D972                 FDB      WRTDIR    WRTDIR  WRITE DIRECTORY
0303 D4E8 DBED                 FDB      DELETE    DELETE  DELETE FILE
0304 D4EA DB43                 FDB      RENAME    RENAME  RENAME FILE
0305 D4EC D6A1                 FDB      RETRY4    RETRY4  APPEND FILES
0306 D4EE DA9E                 FDB      NEXTS     NEXTS   NEXT SEQU. SECTOR
0307 D4F0 D818                 FDB      OPNSIR    OPNSIR  OPEN SYSTEM INFO
0308 D4F2 D577                 FDB      GETRAN    GETRAN  GET RANDOM CHARACTER
0309 D4F4 D598                 FDB      PUTRAN    PUTRAN  WRITE RANDOM CHARACTE
0310 D4F6 DB1E                 FDB      WTAPP     WTAPP   OPEN WRITE APPEND
0311 D4F8 DDD5                 FDB      NXTRDY    NXTRDY  FIND NEXT READY DRIVE
0312 D4FA DD13                 FDB      POSIT     POSIT   POSITION TO RECORD N
0313 D4FC DCFD                 FDB      BKREC     BKREC   BACKUP ONE RECORD
0314                 
0315                 *
0316                 * THE FOLLOWING ROUTINES ARE THE SYSTEM
0317                 * LEVEL ROUTINES USED BY THE FMS.
0318                 
0319                 * SETFCB
0320                 *
0321                 * SETFCB IS USED TO TELL THE SYSTEM
0322                 * WHERE THE NEW FCB IS LOCATED.
0323                 * IT SETS UP A CHAINED STRUCTURE
0324                 * WITH FCBBAS AS THE BASE OF THE CHAIN.
0325                 *
0326                 *   ENTRY: NONE
0327                 *   EXIT:  CS IF FCB EXISTS
0328                 *          ALL REGISTERS CHANGED
0329                 
0330 D4FE 8D20       SETFCB    BSR      FNDFCB    FIND FCB
0331 D500 2605                 BNE      SETFC2    ERROR?
0332 D502 C602                 LDB      #FBER     FILE BUSY
0333 D504 1A01                 ORCC     #1        SEC SHOW ERROR
0334 D506 39                   RTS
0335                 
0336 D507 ED84       SETFC2    STD      0,X       SET FCB
0337 D509 AE84                 LDX      0,X       GET FCB POS
0338 D50B 6F84                 CLR      0,X       CLEAR LAST LINK
0339 D50D 6F01                 CLR      1,X       ALSO SHOWS NO ERROR
0340 D50F 39                   RTS
0341                 
0342                 * REMFCB
0343                 *
0344                 * REMFCB IS USED TO REMOVE AN ACTIVE
0345                 * FCB FROM THE SYSTEM FCB LIST.
0346                 *
0347                 *   ENTRY: NONE
0348                 *   EXIT:  CS IF FCB NOT FOUND
0349                 *          ALL REGISTERS CHANGED
0350                 
0351 D510 8D0E       REMFCB    BSR      FNDFCB    FIND FCB
0352 D512 2705                 BEQ      REMFC2    ERROR?
0353 D514 C60D                 LDB      #IFER     SET ERROR CODE
0354 D516 1A01                 ORCC     #1        SEC SHOW ERROR
0355 D518 39                   RTS
0356                 
0357 D519 EC94       REMFC2    LDD      [0,X]     GET NEXT LINK
0358 D51B ED84                 STD      0,X       SAVE NEW VALUE
0359 D51D 1CFE                 ANDCC    #$FE      CLC CLEAR ERRORS
0360 D51F 39                   RTS
0361                 
0362                 * FNDFCB
0363                 *
0364                 * FNDFCB TRIES TO FIND THE FCB IN
0365                 * FCBSTR IN THE SYSTEM TABLE.
0366                 *
0367                 *   ENTRY: NONE
0368                 *   EXIT:  NE IF NOT FOUND
0369                 *          A & B DESTROYED
0370                 *          X POINTS TO FCB
0371                 
0372 D520 FCD40B     FNDFCB    LDD      FCBSTR    PICKUP FCB
0373 D523 C3001C               ADDD     #FLP      SET TO LIST PNTR
0374 D526 8ED409               LDX      #FCBBAS   GET BASE LOC.
0375 D529 10AE84     FNDFC3    LDY      0,X       CHECK FOR LIST END
0376 D52C 2603                 BNE      FNDFC4
0377 D52E 1CFB                 ANDCC    #$FB      SET NE BIT
0378 D530 39                   RTS
0379                 
0380 D531 10A384     FNDFC4    CMPD     0,X       COMPARE VALUE
0381 D534 2601                 BNE      FNDFC6
0382 D536 39                   RTS                RET WITH EQ
0383                 
0384 D537 AE84       FNDFC6    LDX      0,X       MOVE TO NEXT FCB
0385 D539 20EE                 BRA      FNDFC3    REPEAT
0386                 
0387                 * CLRFCB
0388                 *
0389                 * CLRFCB CLEARS SELECTED SECTIONS OF
0390                 * THE CURRENT FCB.
0391                 *
0392                 *   ENTRY: NONE
0393                 *   EXIT:  ALL REGISTERS CHANGED
0394                 
0395 D53B BED40B     CLRFCB    LDX      FCBSTR    GET FCB
0396 D53E 4F                   CLRA               CLEAR A BYTE
0397 D53F 5F                   CLRB               GET SECTOR LENGTH \\\\
0398 D540 8D02                 BSR      CLRFC2    CLEAR OUT
0399 D542 C62F                 LDB      #FSB-FSA
0400 D544 A78811     CLRFC2    STA      FSA,X     CLEAR BYTE
0401 D547 3001                 LEAX     1,X       BUMP THE POINTER
0402 D549 5A                   DECB               DEC THE COUNT
0403 D54A 26F8                 BNE      CLRFC2    LOOP TIL DONE
0404 D54C 39                   RTS
0405                 
0406                 * COPNAM
0407                 *
0408                 * COPNAM WILL COPY THE NAME (NL BYTES)
0409                 * FROM FCB AREA FFN (FILE NAME) TO THE
0410                 * AREA FWB (WORK BUFFER).
0411                 *
0412                 *   ENTRY: NONE
0413                 *   EXIT:  ALL REGISTERS CHANGED
0414                 
0415 D54D BED40B     COPNAM    LDX      FCBSTR    PICKUP FCB
0416 D550 C60B                 LDB      #NL       SET NAME LENGTH
0417 D552 A604       COPNA2    LDA      FFN,X     GET CHARACTER
0418 D554 A78824               STA      FWB,X     MOVE IT
0419 D557 3001                 LEAX     1,X       BUMP THE POINTER
0420 D559 5A                   DECB               DEC THE COUNTER
0421 D55A 26F6                 BNE      COPNA2
0422 D55C 39                   RTS
0423                 
0424                 * CMPNAM
0425                 *
0426                 * CMPNAM WILL COMPARE THE NAME (NL
0427                 * BYTES LONG) IN THE FCB AREA FWB
0428                 * (WORK BUFFER) TO THE CONTENTS OF
0429                 * FCB AREA FFN (FILE NAME).
0430                 *
0431                 *   ENTRY: NONE
0432                 *   EXIT:  NE IF NOT EQUAL
0433                 *          ALL REGISTERS CHANGED
0434                 
0435 D55D BED40B     CMPNAM    LDX      FCBSTR    PICKUP FCB
0436 D560 C60B                 LDB      #NL       SET LENGTH
0437                 
0438 D562 A604       CMPNA1    LDA      FFN,X     GET CHARACTER
0439 D564 8A20                 ORA      #$20      MAKE LOWERCASE
0440 D566 3402                 PSHS     A
0441 D568 A68824               LDA      FWB,X     GET 2ND CHARACTER
0442 D56B 8A20                 ORA      #$20      MAKE LOWERCASE
0443 D56D A1E0                 CMPA     0,S+      COMPARE THEM
0444 D56F 2605                 BNE      CMPNA4    NOT EQUAL?
0445                 
0446 D571 3001                 LEAX     1,X       BUMP THE POINTER
0447 D573 5A                   DECB               DEC THE COUNTER
0448 D574 26EC                 BNE      CMPNA1    REPEAT
0449 D576 39         CMPNA4    RTS
0450                 
0451                 * GETRAN   * FFC #17 *
0452                 *
0453                 * GETRAN GETS A RANDOM CHARACTER FROM
0454                 * THE CURRENT FSB.
0455                 *
0456                 *   ENTRY: FRI CONTAINS DESIRED INDEX
0457                 *   EXIT:  CS IF FRI OUT OF RANGE
0458                 *          A CONTAINS CHARACTER
0459                 *          B & X CHANGED
0460                 
0461 D577 BED40B     GETRAN    LDX      FCBSTR    GET FCB
0462 D57A E602                 LDB      FAS,X     GET STATUS
0463 D57C 54                   LSRB               CHECK IF R OR RW
0464 D57D 2479                 BCC      REWIN2    GO SET ERROR
0465 D57F E68823               LDB      FRI,X     GET RANDOM INDEX
0466 D582 7ED608               JMP      RDSEQ0
0467                 
0468                 * PUTNXT
0469                 *
0470                 * PUTNXT PUTS THE CHARACTER IN A INTO
0471                 * THE NEXT AVAILABLE FSB LOCATION
0472                 * POINTED TO BY THE FDI.
0473                 *
0474                 *   ENTRY: A CONTAINS CHARACTER
0475                 *   EXIT:  CS IF LAST FSB POS. USED
0476                 *          B & X CHANGED
0477                 
0478 D585 BED40B     PUTNXT    LDX      FCBSTR    PICKUP FCB
0479 D588 E68822               LDB      FDI,X     GET DATA INDEX
0480 D58B 6C8822               INC      FDI,X     BUMP FDI
0481 D58E 3A                   ABX                ADD IN INDEX
0482 D58F A78840               STA      FSB,X     PUT THE CHARACTER
0483 D592 5C                   INCB               BUMP IT
0484 D593 261F                 BNE      PUTRA2    OVER END OF FSB?
0485 D595 1A01                 ORCC     #1        SEC OVER END!
0486 D597 39                   RTS
0487                 
0488                 * PUTRAN   * FFC #18 *
0489                 *
0490                 * PUTRAN PUTS THE CHARACTER IN A
0491                 * IN THE FSB LOCATION INDEXED BY
0492                 * THE FRI.
0493                 *
0494                 *   ENTRY: A CONTAINS CHARACTER
0495                 *          FRI CONTAINS INDEX
0496                 *   EXIT:  CS IF FRI OUT OF RANGE
0497                 *          B & X CHANGED
0498                 
0499 D598 BED40B     PUTRAN    LDX      FCBSTR    GET FCB
0500 D59B E602                 LDB      FAS,X     CHECK IF RW
0501 D59D C403                 ANDB     #3        MASK OFF
0502 D59F C103                 CMPB     #3        IS IT RW?
0503 D5A1 2655                 BNE      REWIN2    SKIP IF ERROR
0504 D5A3 CA80                 ORB      #$80      SET UPDATE BIT
0505 D5A5 E702                 STB      FAS,X     SAVE IT
0506 D5A7 E60F                 LDB      FID,X     CHECK WP
0507 D5A9 C580                 BITB     #$80
0508 D5AB 260A                 BNE      PUTRA4
0509 D5AD E68823               LDB      FRI,X     GET RANDOM INDEX
0510 D5B0 3A                   ABX                ADD IN INDEX
0511 D5B1 A78840               STA      64,X      FSB,X PUT CHARACTER
0512                 
0513 D5B4 1CFE       PUTRA2    ANDCC    #$FE      CLC CLEAR ERROR
0514 D5B6 39                   RTS
0515                 
0516 D5B7 C60B       PUTRA4    LDB      #WPER     SET WP ERROR
0517 D5B9 1A01                 ORCC     #1        SEC SET ERROR
0518 D5BB 39                   RTS
0519                 
0520                 * SRDSEQ
0521                 *
0522                 * SRDSEQ IS THE HIGH LEVEL READ
0523                 * SEQUENTIAL CHARACTER ROUTINE.
0524                 * CONTROL CHARACTERS AND SPACE
0525                 * EXPANSION ARE HANDLED HERE UNLESS
0526                 * FSC IS NEGATIVE.
0527                 *
0528                 *   ENTRY: NONE
0529                 *   EXIT:  CS IF ERROR
0530                 *          B HAS ERROR NUMBER
0531                 *          A & X CHANGED
0532                 
0533 D5BC A6883B     SRDSEQ    LDA      FSC,X     CHECK FOR SP. EXP.
0534 D5BF 2B3C                 BMI      RDSEQ     CONTROL IGNORE?
0535 D5C1 2707                 BEQ      SRDSE2    ACTIVE EXPANSION?
0536 D5C3 6A883B               DEC      FSC,X     DEC THE SPACE COUNT
0537 D5C6 8620                 LDA      #SPC      SETUP SPACE
0538 D5C8 201D                 BRA      SRDSE7    FINISH UP
0539                 
0540 D5CA 8D31       SRDSE2    BSR      RDSEQ     READ NEXT CHAR
0541 D5CC 251B                 BCS      SRDSE8    ERRORS?
0542 D5CE 8118                 CMPA     #DELC     IS IT DELETED?
0543 D5D0 2215                 BHI      SRDSE7    SKIP ALL SPECIALS
0544 D5D2 27F6                 BEQ      SRDSE2
0545 D5D4 8109                 CMPA     #SCC      SPACE COMP CHAR?
0546 D5D6 260C                 BNE      SRDSE6
0547 D5D8 8D23                 BSR      RDSEQ     GO GET COUNT
0548 D5DA 250D                 BCS      SRDSE8    ERROR?
0549 D5DC BED40B               LDX      FCBSTR    RESTORE POINTER
0550 D5DF A7883B               STA      FSC,X     SAVE COUNT
0551 D5E2 20D8                 BRA      SRDSEQ    REPEAT
0552                 
0553 D5E4 4D         SRDSE6    TSTA               IS CHAR NULL?
0554 D5E5 27E3                 BEQ      SRDSE2    IGNORE IF SO
0555                 
0556 D5E7 1CFE       SRDSE7    ANDCC    #$FE      CLC CLEAR ERROR
0557 D5E9 39         SRDSE8    RTS
0558                 
0559                 * REWIND   * FFC #5 *
0560                 *
0561                 * REWIND WILL LOGICALLY REWIND THE
0562                 * FILE SPECIFIED IN THE FCB.
0563                 *
0564                 *   ENTRY: NONE
0565                 *   EXIT:  SAME AS RDNEXT
0566                 
0567 D5EA BDDAC8     REWIND    JSR      DOSTAT    CHECK STATUS
0568 D5ED 2509                 BCS      REWIN2    ERROR?
0569 D5EF 8501                 BITA     #1        CHECK FOR R BIT
0570 D5F1 2705                 BEQ      REWIN2    ERROR?
0571 D5F3 A784                 STA      FFC,X     SET FFC
0572 D5F5 7ED9A9               JMP      OPNRD1    GO SETUP FILE
0573                 
0574 D5F8 C612       REWIN2    LDB      #STER     SET ERROR CODE
0575 D5FA 1A01                 ORCC     #1        SEC SHOW ERROR
0576 D5FC 39                   RTS
0577                 
0578                 * RDSEQ
0579                 *
0580                 * RDSEQ IS THE LOW LEVEL GET
0581                 * SEQUENTIAL CHARACTER ROUTINE.
0582                 *
0583                 *   ENTRY: NONE
0584                 *   EXIT:  CHAR IN A
0585                 *          CS IF ERROR
0586                 *          B & X DESTROYED
0587                 
0588 D5FD BED40B     RDSEQ     LDX      FCBSTR    PICKUP FCB
0589 D600 E68822               LDB      FDI,X     GET DATA INDEX
0590 D603 270A                 BEQ      RDSEQ1
0591 D605 6C8822               INC      FDI,X     BUMP DATA INDEX
0592                 
0593 D608 3A         RDSEQ0    ABX                ADD IN OFFSET
0594 D609 A68840               LDA      FSB,X     GET CHARACTER
0595 D60C 1CFE                 ANDCC    #$FE      CLC
0596 D60E 39                   RTS
0597                 
0598 D60F 8D03       RDSEQ1    BSR      RDNEXT    GET NEXT RECORD
0599 D611 24EA                 BCC      RDSEQ     ERRORS?
0600 D613 39                   RTS
0601                 
0602                 * RDNEXT
0603                 *
0604                 * RDNEXT READS THE NEXT SEQUENTIAL
0605                 * RECORD IF IT EXISTS.
0606                 *
0607                 *   ENTRY: NONE
0608                 *   EXIT:  CS IF ERROR
0609                 *          B HAS ERROR NUMBER
0610                 *          A & X CHANGED
0611                 
0612 D614 BED40B     RDNEXT    LDX      FCBSTR    PICKUP FCB
0613 D617 EC8840               LDD      FSB,X     GET TRACK & SECTOR
0614 D61A 6C8821               INC      FRN+1,X   BUMP REC NUM
0615 D61D 2603                 BNE      RDNEX1
0616 D61F 6C8820               INC      FRN,X
0617                 
0618 D622 10830000   RDNEX1    CMPD     #$0000    TEST IF 0 LINK
0619 D626 271C                 BEQ      RDNEX4    END OF FILE?
0620 D628 ED881E     RDNEX2    STD      FCS,X     SET CURRENT ADR.
0621 D62B 3402                 PSHS     A
0622 D62D 8604                 LDA      #RS       SET RECORD START
0623 D62F A78822               STA      FDI,X     SAVE IT
0624 D632 3502                 PULS     A
0625 D634 8D13                 BSR      READSS    GO DO READ
0626 D636 2410                 BCC      RDNEX8    ERRORS?
0627 D638 C580                 BITB     #$80      CHECK NOT READY
0628 D63A 2704                 BEQ      RDNEX3
0629 D63C C610                 LDB      #NRER     SET ERROR
0630 D63E 2006                 BRA      RDNEX6
0631                 
0632 D640 C609       RDNEX3    LDB      #RDER     SET READ ERROR
0633 D642 2002                 BRA      RDNEX6
0634                 
0635 D644 C608       RDNEX4    LDB      #EFER     SET EOF ERROR
0636 D646 1A01       RDNEX6    ORCC     #1        SEC SHOW ERROR
0637 D648 39         RDNEX8    RTS
0638                 
0639                 * READSS   * FFC #9 *
0640                 *
0641                 * READSS READS A SINGLE RECORD (SECTOR)
0642                 * FROM THE DISK.
0643                 *
0644                 *   ENTRY: NONE
0645                 *   EXIT:  CS IF READ ERROR
0646                 *          ALL REGISTERS CHANGED
0647                 
0648 D649 8D25       READSS    BSR      CLRTRY    CLEAR TRY COUNTERS
0649 D64B BED40B               LDX      FCBSTR    SET POINTER
0650 D64E BDDE0C               JSR      DRIVE     DO DRIVE SEL
0651 D651 2512                 BCS      READS6
0652                 
0653 D653 8D11       READS2    BSR      GETCUR    GET DISK ADDRESS
0654 D655 BDDE00               JSR      DREAD     GO READ RECORD
0655 D658 2603                 BNE      READS4    ERRORS?
0656 D65A 1CFE                 ANDCC    #$FE      CLC CLEAR ERROR
0657 D65C 39                   RTS
0658                 
0659 D65D 3404       READS4    PSHS     B         SAVE B
0660 D65F 8D17                 BSR      RETRY     CHECK IF RETRY
0661 D661 3504                 PULS     B         RESTORE B
0662 D663 24EE                 BCC      READS2    TRY AGAIN?
0663                 
0664 D665 39         READS6    RTS
0665                 
0666                 * GETCUR
0667                 *
0668                 * GETCUR GETS THE CURRENT RECORD ADDRESS
0669                 * (TRACK AND SECTOR) INTO A & B.
0670                 * IF ILLEGAL ADDRESS, CARRY IS SET.
0671                 *
0672                 *   ENTRY: NONE
0673                 *   EXIT:  CS IF ILLEGAL ADR.
0674                 *          A = TRACK NUMBER
0675                 *          B = SECTOR NUMBER
0676                 *          X POINTS TO FSB
0677                 
0678 D666 BED40B     GETCUR    LDX      FCBSTR    PICKUP FCB
0679 D669 EC881E               LDD      FCS,X     GET TRACK & SECTOR
0680 D66C 308840               LEAX     FSB,X     ADD FSB BIAS
0681 D66F 39                   RTS
0682                 
0683                 * CLRTRY
0684                 *
0685                 * CLRTRY CLEARS THE ERROR TRY COUNTERS
0686                 *
0687                 *   ENTRY: NONE
0688                 *   EXIT:  A CLEARED
0689                 
0690 D670 4F         CLRTRY    CLRA               CLEAR A
0691 D671 B7D411               STA      ETRIES    CLEAR COUNTERS
0692 D674 B7D412               STA      STRIES
0693 D677 39                   RTS
0694                 
0695                 * RETRY
0696                 *
0697                 * RETRY WILL TEST THE TRY COUNTERS
0698                 * ETRIES AND STRIES TO SEE IF THEY
0699                 * ARE AT MAXIMUM.
0700                 * A RESTORE OPERATION IS PERFORMED
0701                 * IF NECESSARY.
0702                 *
0703                 *   ENTRY: NONE
0704                 *   EXIT:  CS IF NO MORE TRIES LEFT
0705                 
0706 D678 C510       RETRY     BITB     #$10      CHECK IF SEEK ERROR
0707 D67A 2611                 BNE      RETRY2
0708 D67C C580                 BITB     #$80      CHECK NOT READY
0709 D67E 2624                 BNE      RETRY6
0710 D680 F6D411               LDB      ETRIES    CHECK ERROR CNTR
0711 D683 5C                   INCB               BUMP IT ONE
0712 D684 C105                 CMPB     #RTC      IS IT MAXIMUM?
0713 D686 2705                 BEQ      RETRY2
0714                 
0715 D688 F7D411               STB      ETRIES    SAVE COUNT
0716 D68B 2014                 BRA      RETRY4
0717                 
0718 D68D 7FD411     RETRY2    CLR      ETRIES    CLEAR COUNTER
0719 D690 F6D412               LDB      STRIES    CHECK SEEK CNTR
0720 D693 5C                   INCB               BUMP IT
0721 D694 C107                 CMPB     #RSC      IS IT MAXIMUM?
0722 D696 270C                 BEQ      RETRY6
0723 D698 F7D412               STB      STRIES    SAVE COUNTER
0724 D69B BED40B               LDX      FCBSTR
0725 D69E BDDE09               JSR      RESTOR    GO RESTORE
0726                 
0727 D6A1 1CFE       RETRY4    ANDCC    #$FE      CLC CLEAR ERROR
0728 D6A3 39                   RTS
0729                 
0730 D6A4 1A01       RETRY6    ORCC     #1        SEC SET ERROR
0731 D6A6 39                   RTS
0732                 
0733                 * WRITSS   * FFC #10 *
0734                 *
0735                 * WRITSS IS THE SYSTEM WRITE SINGLE
0736                 * SECTOR ROUTINE.
0737                 *
0738                 *   ENTRY: NONE
0739                 *   EXIT:  CS IF WRITE ERROR
0740                 *          ALL REGISTERS CHANGED
0741                 
0742 D6A7 8DC7       WRITSS    BSR      CLRTRY    CLEAR TRY COUNTERS
0743 D6A9 BED40B               LDX      FCBSTR    SET POINTER
0744 D6AC BDDE0C               JSR      DRIVE     DO DRIVE SEL
0745 D6AF 2520                 BCS      WRITS6
0746                 
0747 D6B1 BED40B     WRITS2    LDX      FCBSTR    SET POINTER
0748 D6B4 8DB0                 BSR      GETCUR    GET CURRENT SEC
0749 D6B6 BDDE03               JSR      DWRITE    DO ACTUAL WRITE
0750 D6B9 260A                 BNE      WRITS4    ERRORS?
0751                 
0752 D6BB B6D435               LDA      VRFYFG    VERIFY SECTOR?
0753 D6BE 2737                 BEQ      SWTSE6    NO VERIFY
0754                 
0755 D6C0 BDDE06               JSR      VERIFY    GO DO VERIFY
0756 D6C3 2732                 BEQ      SWTSE6    ERROR?
0757                 
0758 D6C5 C540       WRITS4    BITB     #$40      CHECK IF W.P.
0759 D6C7 260B                 BNE      WRITS8
0760 D6C9             
0761 D6C9 3404                 PSHS     B         SAVE STATUS
0762 D6CB 8DAB                 BSR      RETRY     RETRY?
0763 D6CD 3504                 PULS     B         RESTORE STATUS
0764 D6CF 24E0                 BCC      WRITS2    TRY AGAIN
0765 D6D1 39         WRITS6    RTS                ERROR RETURN
0766                 
0767 D6D2 C620       WRITS7    LDB      #$20      SET ERROR
0768 D6D4 1A01       WRITS8    ORCC     #1        SHOW ERROR
0769 D6D6 39                   RTS                ERROR RETURN
0770                 
0771                 * SWTSEQ
0772                 *
0773                 * SWTSEQ IS THE HIGH LEVEL WRITE
0774                 * SEQUENTIAL CHARACTER ROUTINE.
0775                 * SPACE COMPRESSION IS HANDLED HERE
0776                 * UNLESS FSC IS NEGATIVE.
0777                 *
0778                 *   ENTRY: NONE
0779                 *   EXIT:  CS IF ERROR
0780                 *          B HAS ERROR NUMBER
0781                 *          A & X CHANGED
0782                 
0783 D6D7 BED40B     SWTSEQ    LDX      FCBSTR    PICKUP FCB
0784 D6DA E6883B               LDB      FSC,X     GET SPC COUNT
0785 D6DD 2B3D                 BMI      WTSEQ     WRITE IF NEG.
0786 D6DF 8120                 CMPA     #SPC      IS CHARACTER SPACE?
0787 D6E1 260F                 BNE      SWTSE4
0788 D6E3 5C                   INCB               BUMP THE COUNT
0789 D6E4 E7883B               STB      FSC,X     SAVE IT
0790 D6E7 C17F                 CMPB     #MAXSP    MAXIMUM?
0791 D6E9 260C                 BNE      SWTSE6
0792 D6EB 200D                 BRA      PUTSPC    ** FIX FOR 128 SPACES **
0793                 
0794 D6ED 8D0B       SWTSE2    BSR      PUTSPC    GO PUT SPACES
0795 D6EF 24E6                 BCC      SWTSEQ    ERRORS?
0796 D6F1 39                   RTS
0797                 
0798 D6F2 5D         SWTSE4    TSTB               COUNT ZERO?
0799 D6F3 2727                 BEQ      WTSEQ
0800 D6F5 20F6                 BRA      SWTSE2    DO SPACES
0801                 
0802 D6F7 1CFE       SWTSE6    ANDCC    #$FE      CLC CLEAR ERRORS
0803 D6F9 39                   RTS
0804                 
0805                 * PUTSPC
0806                 *
0807                 * PUTSPC IS THE ROUTINE WHICH WRITES
0808                 * THE SPACE COMPRESSION CODE AND THE
0809                 * SPACE COUNT.
0810                 *
0811                 *   ENTRY: B HAS COUNT
0812                 *   EXIT:  A PRESERVED
0813                 
0814 D6FA 3402       PUTSPC    PSHS     A         SAVE CHAR
0815 D6FC C101                 CMPB     #1        IS COUNT 1?
0816 D6FE 2604                 BNE      PUTSP2
0817 D700 8620                 LDA      #$20      SETUP SPACE
0818 D702 2010                 BRA      PUTSP4    GO WRITE
0819                 
0820 D704 8609       PUTSP2    LDA      #SCC      SETUP SCC
0821 D706 8D14                 BSR      WTSEQ     WRITE IT OUT
0822 D708 3502                 PULS     A
0823 D70A 250F                 BCS      PUTSP6    ERROR?
0824 D70C 3402                 PSHS     A         SAVE CHAR
0825 D70E BED40B               LDX      FCBSTR    PICKUP FCB
0826 D711 A6883B               LDA      FSC,X     GET COUNT
0827 D714 6F883B     PUTSP4    CLR      FSC,X     CLEAR COUNT
0828 D717 8D03                 BSR      WTSEQ     WRITE COUNT
0829 D719 3502                 PULS     A         RESTORE CHAR
0830 D71B 39         PUTSP6    RTS
0831                 
0832                 * WTSEQ
0833                 *
0834                 * WTSEQ WRITES THE NEXT CHARACTER TO
0835                 * THE FSB AREA OF THE FCB.
0836                 *
0837                 *   ENTRY: A HAS CHARACTER
0838                 *   EXIT:  CS IF ERROR
0839                 *          B HAS ERROR NUMBER
0840                 *          X CHANGED
0841                 
0842 D71C BED40B     WTSEQ     LDX      FCBSTR    GET FCB POINTER
0843 D71F E602                 LDB      FAS,X     GET ACTIVE STATUS
0844 D721 C102                 CMPB     #2        IS IT WRITE?
0845 D723 1026FED1             LBNE     REWIN2    ERROR IF NOT
0846 D727 E68822               LDB      FDI,X     GET INDEX
0847 D72A C104                 CMPB     #RS       IS IT BEGINNING?
0848 D72C 2608                 BNE      WTSEQ2
0849 D72E 3402                 PSHS     A         SAVE CHAR.
0850 D730 8D21                 BSR      WTNEXT    GO WRITE RECORD
0851 D732 3502                 PULS     A         RESTORE CHAR.
0852 D734 250F                 BCS      WTSEQ4    ERRORS?
0853                 
0854 D736 BDD585     WTSEQ2    JSR      PUTNXT    PUT CHARACTER
0855 D739 240A                 BCC      WTSEQ4    LAST SPACE USED?
0856 D73B C604                 LDB      #RS       SET RECORD START
0857 D73D BED40B               LDX      FCBSTR    POINT TO FCB
0858 D740 E78822               STB      FDI,X     SET INDEX
0859 D743 1CFE                 ANDCC    #$FE      CLC CLEAR ERRORS
0860 D745 39         WTSEQ4    RTS
0861                 
0862                 * CLRLRN
0863                 
0864 D746 BED40B     CLRLRN    LDX      FCBSTR    GET POINTER
0865 D749 4F                   CLRA
0866 D74A 5F                   CLRB
0867 D74B ED8820               STD      FRN,X     CLEAR LRN
0868 D74E ED8842               STD      FSB+2,X   CLEAR ACTUAL RN
0869 D751 2027                 BRA      WTNEX1    GO WRITE NEXT
0870                 
0871                 * WTNEXT
0872                 *
0873                 * WTNEXT WRITES THE NEXT RECORD.
0874                 *
0875                 *   ENTRY: X = FCB
0876                 *   EXIT:  CS IF ERROR
0877                 *          REGISTERS CHANGED
0878                 
0879 D753 E68812     WTNEXT    LDB      FSA+1,X   FIRST RECORD?
0880 D756 2622                 BNE      WTNEX1
0881 D758 E68817               LDB      FMP,X     CHECK FOR RANDOM
0882 D75B 2744                 BEQ      ASNNXT
0883 D75D 6F8817               CLR      FMP,X     CLEAR FLAG
0884 D760 8D3F                 BSR      ASNNXT    GO ASSIGN
0885 D762 252A                 BCS      GETFS2    ERROR?
0886 D764 8DE0                 BSR      CLRLRN    CLEAR LRN
0887 D766 2526                 BCS      GETFS2    ERROR?
0888 D768 8DDC                 BSR      CLRLRN    CLEAR NEXT
0889 D76A 2522                 BCS      GETFS2    ERROR?
0890 D76C BED40B               LDX      FCBSTR    GET FCB
0891 D76F C602                 LDB      #2        SET FSM COUNT
0892 D771 E78817               STB      FMP,X
0893 D774 EC8811               LDD      FSA,X     GET START ADDR
0894 D777 7EDC99               JMP      UPDF75    GO DO UPDATE
0895                 
0896 D77A 8D0E       WTNEX1    BSR      GETFST    GET FIRST AVAIL
0897 D77C BED40B               LDX      FCBSTR    SET FCB PNTR
0898 D77F ED8840               STD      FSB,X     SET FORWARD LINK
0899 D782 BDD6A7               JSR      WRITSS    WRITE RECORD
0900 D785 241A                 BCC      ASNNXT    ERROR?
0901 D787 7EDBD8               JMP      WRTERR    REPORT ERROR
0902                 
0903                 * GETFST
0904                 *
0905                 * GETFST LOADS THE FIRST AVAILABLE
0906                 * SECTOR ADDRESS INTO A & B.
0907                 *
0908                 *   ENTRY: NONE
0909                 *   EXIT:  EQ IF FSTAVL = 00
0910                 *          X UNCHANGED
0911                 *          A & B = FSTAVL H & L
0912                 
0913 D78A 8D03       GETFST    BSR      FSECMP    FIND SECTOR MAP
0914 D78C EC84                 LDD      0,X       GET FIRST AVAIL.
0915 D78E 39         GETFS2    RTS
0916                 
0917                 * FSECMP
0918                 *
0919                 * FSECMP FINDS THE SECTOR MAP
0920                 * CORRESPONDING TO THE CURRENT
0921                 * DRIVE SELECTED IN THE FCB.
0922                 *
0923                 *   ENTRY: NONE
0924                 *   EXIT:  EQ IF AVAIL NOT SET
0925                 *          X POINTS TO SECTOR MAP
0926                 
0927 D78F BED40B     FSECMP    LDX      FCBSTR    PICKUP FCB
0928 D792 E603                 LDB      FDN,X     GET DRIVE NUMBER
0929 D794 8606                 LDA      #6        MULTIPLY TIMES 6
0930 D796 3D                   MUL
0931 D797 8ED41D               LDX      #SECMAP   POINT TO MAPS
0932 D79A 3A                   ABX                FIX POINTER
0933 D79B BFD41B               STX      AVLPNT    SET POINTER
0934 D79E 6D84                 TST      0,X       IS AVAIL EMPTY?
0935 D7A0 39                   RTS
0936                 
0937                 * ASNNXT
0938                 *
0939                 * ASNNXT ASSIGNS THE NEXT AVAILABLE
0940                 * RECORD TO THE CURRENT OPEN WRITE
0941                 * FILE POINTED TO BY THE FCB.
0942                 *
0943                 *   ENTRY: NONE
0944                 *   EXIT:  CS IF ERROR
0945                 *          ALL REGISTERS CHANGED
0946                 
0947 D7A1 8DE7       ASNNXT    BSR      GETFST    GET FSTAVL
0948 D7A3 2605                 BNE      ASNNX2    IS IT ZERO?
0949 D7A5 C607                 LDB      #DFER     DISK FULL!
0950 D7A7 1A01       ASNNX1    ORCC     #1        SEC SET ERROR
0951 D7A9 39                   RTS
0952                 
0953 D7AA BED40B     ASNNX2    LDX      FCBSTR    GET FCB POINTER
0954 D7AD ED8813               STD      FEA,X     SET END ADDRESS
0955 D7B0 6D8812               TST      FSA+1,X   IS THIS FIRST?
0956 D7B3 2603                 BNE      ASNNX4    JUMP AHEAD IF NOT
0957 D7B5 ED8811               STD      FSA,X     SET START ADDRESS
0958                 
0959 D7B8 6C8816     ASNNX4    INC      FSZ+1,X   BUMP FILE SIZE
0960 D7BB 2603                 BNE      ASNNX6
0961 D7BD 6C8815               INC      FSZ,X     FIX MSB
0962                 
0963 D7C0 6D8817     ASNNX6    TST      FMP,X     CHECK FOR RANDOM
0964 D7C3 270B                 BEQ      ASNN65
0965 D7C5 BDDC5A               JSR      UPDFSM    UPDATE FSM ENTRY
0966 D7C8 25DD                 BCS      ASNNX1    ERROR?
0967 D7CA BED40B               LDX      FCBSTR    GET FCB
0968 D7CD EC8813               LDD      FEA,X     GET END ADDRESS
0969                 
0970 D7D0 BDD628     ASNN65    JSR      RDNEX2    READ NEXT RECORD
0971 D7D3 25D2                 BCS      ASNNX1    READ ERROR?
0972 D7D5 BED40B               LDX      FCBSTR    POINT TO FCB
0973 D7D8 EC8840               LDD      FSB,X     GET FOR. LINK
0974 D7DB 3406                 PSHS     A,B       SAVE LINK
0975 D7DD 8DB0                 BSR      FSECMP    FIND SECTOR MAP
0976 D7DF 3506                 PULS     A,B       RESTORE LINK
0977 D7E1 ED84                 STD      0,X       SET FIRST AVAIL
0978 D7E3 260A                 BNE      ASNNX7    FULL DISK??
0979                 
0980 D7E5 6F02                 CLR      2,X       CLEAR OUT REST
0981 D7E7 6F03                 CLR      3,X
0982 D7E9 6F04                 CLR      4,X
0983 D7EB 6F05                 CLR      5,X
0984 D7ED 2008                 BRA      ASNNX8    GO AHEAD
0985                 
0986 D7EF 10AE04     ASNNX7    LDY      4,X       GET SEC COUNT
0987 D7F2 313F                 LEAY     -1,Y      DEC BY 1
0988 D7F4 10AF04               STY      4,X       SAVE RESULT
0989                 
0990 D7F7 4F         ASNNX8    CLRA               CLEAR REGISTER
0991 D7F8 BED40B               LDX      FCBSTR    SET POINTER
0992 D7FB 6C8821               INC      FRN+1,X   INC LRN
0993 D7FE 2603                 BNE      ASNN85
0994 D800 6C8820               INC      FRN,X
0995                 
0996 D803 5F         ASNN85    CLRB               GET SECTOR LENGTH \\\\
0997 D804 A78840     ASNNX9    STA      FSB,X     CLEAR LOCATION
0998 D807 3001                 LEAX     1,X       BUMP POINTER
0999 D809 5A                   DECB               DEC THE COUNTER
1000 D80A 26F8                 BNE      ASNNX9    REPEAT?
1001                 
1002 D80C BED40B               LDX      FCBSTR    GET FCB PNTR
1003 D80F EC8820               LDD      FRN,X     GET LRN
1004 D812 ED8842               STD      FSB+2,X   SAVE IN DATA
1005 D815 1CFE                 ANDCC    #$FE      CLC CLEAR ERRORS
1006 D817 39                   RTS
1007                 
1008                 * OPN - SIR, DIR
1009                 *
1010                 * OPNIR OPENS EITHER THE SYSTEM IR
1011                 * OR THE DIRECTORY IR, DEPENDING ON
1012                 * THE ENTRY POINT.
1013                 *
1014                 *   ENTRY: NONE
1015                 *   EXIT:  B & X DESTROYED
1016                 
1017 D818 5F         OPNSIR    CLRB               SET TRACK 0
1018 D819 3404                 PSHS     B
1019 D81B C603                 LDB      #ISEC     GET SECTOR
1020 D81D 200E                 BRA      OPNIR
1021                 
1022                 * ------- No Path to this code
1023                 
1024 D81F BED415     OPNCUD    LDX      CUD       GET CUD
1025 D822 BFD413               STX      CLD       SAVE AS LOOKUP
1026                 
1027                 * -------
1028                 
1029 D825 F6D413     OPNCLD    LDB      CLD       GET TRACK
1030 D828 3404                 PSHS     B         SAVE IT
1031 D82A F6D414               LDB      CLD+1     GET SECTOR
1032                 
1033 D825            OPNDIR    EQU      OPNCLD
1034                 
1035 D82D BED40B     OPNIR     LDX      FCBSTR    SET FCB POINTER
1036 D830 E78841               STB      FSB+1,X   SAVE SECTOR
1037 D833 3504                 PULS     B         GET TRACK
1038 D835 E78840               STB      FSB,X     SET SECTOR PNTR
1039 D838 7FD418               CLR      BKLN      CLEAR BACK LINK
1040 D83B 5F                   CLRB               GET SECTOR LENGTH \\\\
1041 D83C E78822               STB      FDI,X     SAVE IT
1042 D83F 39                   RTS
1043                 
1044                 * GETIR
1045                 *
1046                 * GETIR GETS THE NEXT INFORMATION
1047                 * RECORD (IR) FROM THE FSB.
1048                 *
1049                 *   ENTRY: X = FCB
1050                 *   EXIT:  CS IF ERROR
1051                 
1052 D840 BED40B     GETIR     LDX      FCBSTR    SET FCB POINTER
1053 D843 E68822               LDB      FDI,X     GET DATA INDEX
1054 D846 261E                 BNE      GETIR2    NEXT SECTOR?
1055                 
1056 D848 BDD614               JSR      RDNEXT    GET NEXT SECTOR
1057 D84B 2531                 BCS      GETIR8    ERROR?
1058                 
1059 D84D BED40B               LDX      FCBSTR    GET FCB POINTER
1060 D850 7DD418               TST      BKLN      TEST BACK LINK
1061 D853 2606                 BNE      GETIR1    IS IT SET?
1062                 
1063 D855 CC0005               LDD      #$0005    < OLD Code
1064                 *       LDD     FSB+4,X    GET NEW BL  <- CORRECTED
1065 D858 FDD418               STD      BKLN      SAVE IT
1066                 
1067 D85B 8610       GETIR1    LDA      #IRS      SET START INDEX
1068 D85D A78822               STA      FDI,X
1069 D860 EC881E               LDD      FCS,X     GET CURRENT SEC ADR
1070 D863 ED882F               STD      FCD,X     SET CURRENT IR
1071                 
1072 D866 A68822     GETIR2    LDA      FDI,X     GET CURRENT INDEX
1073 D869 A78831               STA      FCD+2,X   SAVE IT
1074 D86C C618                 LDB      #IRL      SET LENGTH
1075                 
1076 D86E 3414       GETIR4    PSHS     B,X       SAVE VALUES
1077 D870 BDD5FD               JSR      RDSEQ     READ NEXT CHAR
1078 D873 3514                 PULS     B,X       RESTORE VALUES
1079 D875 A704                 STA      FFN,X     PUT THE CHAR
1080 D877 3001                 LEAX     1,X       BUMP THE POINTER
1081 D879 5A                   DECB               DEC THE COUNT
1082 D87A 26F2                 BNE      GETIR4    FINISHED?
1083                 *       CLRB                CLEAR ERRORS
1084 D87C 1CFE                 ANDCC    #$FE      CLC CLEAR ERROR
1085 D87E 39         GETIR8    RTS
1086                 
1087                 * PUTIR
1088                 *
1089                 * PUTIR PUTS THE IR INTO THE FSB.
1090                 *
1091                 *   ENTRY: NONE
1092                 *   EXIT:  CS IF ERROR
1093                 
1094 D87F BED40B     PUTIR     LDX      FCBSTR    SET FCB POINTER
1095 D882 A68831               LDA      FCD+2,X   GET INDEX
1096 D885 A78822               STA      FDI,X     SET IT
1097 D888 C618                 LDB      #IRL      SET LENGTH COUNT
1098                 
1099 D88A 3414       PUTIR2    PSHS     B,X       SAVE POINTERS
1100 D88C A604                 LDA      FFN,X     GET THE CHAR
1101 D88E BDD71C               JSR      WTSEQ     GO WRITE CHAR
1102 D891 3514                 PULS     B,X       RESTORE POINTERS
1103 D893 3001                 LEAX     1,X       BUMP THE POINTER
1104 D895 5A                   DECB               DEC THE COUNT
1105 D896 26F2                 BNE      PUTIR2    REPEAT?
1106                 
1107 D898 7ED6A7               JMP      WRITSS    GO WRITE SECTOR
1108                 
1109                 * FNDNAM
1110                 *
1111                 * FNDNAM TRIES TO FIND THE NAME IN
1112                 * FFN IN THE DIRECTORY.
1113                 *
1114                 *   ENTRY: NAME IN FFN
1115                 *   EXIT:  EQ IF FOUND
1116                 *          CS IF ERROR ( IN B )
1117                 *          REGISTERS CHANGED
1118                 
1119 D89B BED40B     FNDNAM    LDX      FCBSTR    GET FCB
1120 D89E A603                 LDA      FDN,X     GET DRIVE NUM
1121 D8A0 A78823               STA      FRI,X     SAVE IT IN TEMP
1122 D8A3 B6D417               LDA      DIRDN     GET DIR DRIVE NUM
1123 D8A6 7DD41A               TST      SINDIR    SINGLE DIR ?
1124 D8A9 2631                 BNE      FNDNA1
1125                 
1126 D8AB A703                 STA      FDN,X     SET NEW DRIVE NUM
1127 D8AD BED415               LDX      CUD       GET DIR POINTER
1128 D8B0 BFD413               STX      CLD       SET CLD
1129                 
1130 D8B3 8C0005     FNDN04    CMPX     #MAIND    IS IT MAIN?
1131 D8B6 270C                 BEQ      FNDN06
1132 D8B8 8D22                 BSR      FNDNA1    SEARCH DIR
1133 D8BA 2337                 BLS      FNDNA3    FIND OR ERROR?
1134 D8BC BED418               LDX      BKLN      GET BACK LINK
1135 D8BF BFD413               STX      CLD       SET CLD
1136 D8C2 20EF                 BRA      FNDN04    REPEAT
1137                 
1138 D8C4 BED40B     FNDN06    LDX      FCBSTR    SET POINTER
1139 D8C7 A68823               LDA      FRI,X     RESTORE DN
1140 D8CA A703                 STA      FDN,X
1141 D8CC 2A0E                 BPL      FNDNA1    DRIVE SPECIFIC?
1142                 
1143 D8CE BDDDD5     FNDN08    JSR      NXTRDY    GET NEXT RDY DRV
1144 D8D1 2536                 BCS      FNDNA9    ERROR?
1145 D8D3 8D07                 BSR      FNDNA1    DO SEARCH
1146 D8D5 231C                 BLS      FNDNA3    FIND OR ERROR?
1147 D8D7 BDDDC5               JSR      RSTNAM    RESTORE NAME
1148 D8DA 20F2                 BRA      FNDN08
1149                 
1150 D8DC BED40B     FNDNA1    LDX      FCBSTR    SET POINTER
1151 D8DF 7FD41A               CLR      SINDIR    CLEAR MODE
1152 D8E2 BDD54D               JSR      COPNAM    COPY NAME TO FWB
1153 D8E5 BDD825               JSR      OPNDIR    OPEN DIRECTORY
1154                 
1155 D8E8 BDD840     FNDNA2    JSR      GETIR     GET RECORD
1156 D8EB 2407                 BCC      FNDNA4    ERROR?
1157 D8ED C108                 CMPB     #EFER     END OF FILE?
1158 D8EF 2718                 BEQ      FNDNA9
1159 D8F1 1A01                 ORCC     #1        SEC SET ERROR
1160 D8F3 39         FNDNA3    RTS                ERROR RETURN
1161                 
1162 D8F4 BED40B     FNDNA4    LDX      FCBSTR    POINT TO FCB
1163 D8F7 A604                 LDA      FFN,X     GET CHAR
1164 D8F9 270C                 BEQ      FNDNA8    NO MORE?
1165 D8FB 2A02                 BPL      FNDNA6    DELETED NAME?
1166 D8FD 8D0F                 BSR      SETFD     SET DELETED
1167                 
1168 D8FF BDD55D     FNDNA6    JSR      CMPNAM    COMPARE NAME
1169 D902 26E4                 BNE      FNDNA2    EQUAL?
1170 D904 1CFE                 ANDCC    #$FE      CLC CLEAR ERRORS
1171 D906 39                   RTS
1172                 
1173 D907 8D05       FNDNA8    BSR      SETFD
1174 D909 1CFB       FNDNA9    ANDCC    #$FB      SHOW NO FIND
1175 D90B 1CFE                 ANDCC    #$FE      CLC CLEAR ERRORS
1176 D90D 39                   RTS
1177                 
1178 D90E A68833     SETFD     LDA      FFD+1,X   FIRST DELETED?
1179 D911 260C                 BNE      SETFD2
1180 D913 EC882F               LDD      FCD,X     GET CURRENT ADR
1181 D916 ED8832               STD      FFD,X     SET FIRST DELETED
1182 D919 A68831               LDA      FCD+2,X   GET INDEX
1183 D91C A78834               STA      FFD+2,X   SAVE IT
1184 D91F 39         SETFD2    RTS
1185                 
1186                 * GETAVL
1187                 *
1188                 * GETAVL SETS THE SECTOR MAP POINTERS
1189                 * IF THEY HAVE NOT BEEN SET.
1190                 *
1191                 *   ENTRY: NONE
1192                 *   EXIT:  CS SET IF ERROR
1193                 *          REGISTERS CHANGED
1194                 
1195 D920 BDD78F     GETAVL    JSR      FSECMP    FIND MAP
1196 D923 2617                 BNE      GETAV3    SET YET?
1197 D925 8D18                 BSR      GETDIS    READ IN DIS
1198 D927 2515                 BCS      GETAV4    ERROR?
1199                 
1200 D929 C606                 LDB      #6        SET COUNTER
1201 D92B 10BED40B             LDY      FCBSTR    GET FCB
1202 D92F BED41B               LDX      AVLPNT    POINT TO MAP
1203                 
1204 D932 A6A85D     GETAV2    LDA      FSB+FSA+IRS-4,Y
1205 D935 3121                 LEAY     1,Y
1206 D937 A780                 STA      0,X+
1207 D939 5A                   DECB               DEC THE COUNT
1208 D93A 26F6                 BNE      GETAV2    FINISHED?
1209                 
1210 D93C 1CFE       GETAV3    ANDCC    #$FE      CLC CLEAR ERRORS
1211 D93E 39         GETAV4    RTS
1212                 
1213                 * GETDIS
1214                 *
1215                 * GETDIS READS IN THE DIS SECTOR.
1216                 *
1217                 *   ENTRY: NONE
1218                 *   EXIT:  CS IF ERROR
1219                 *          REGISTERS CHANGED
1220                 
1221 D93F BDD818     GETDIS    JSR      OPNSIR    OPEN THE DIS
1222 D942 BDD614               JSR      RDNEXT    READ NEXT BLOCK
1223 D945 2508                 BCS      GETDI2    ERROR?
1224                 
1225 D947 BED40B               LDX      FCBSTR    SET POINTER
1226 D94A C610                 LDB      #IRS      SET START POINT
1227 D94C E78822               STB      FDI,X     SET INDEX
1228 D94F 39         GETDI2    RTS
1229                 
1230                 * PUTAVL
1231                 *
1232                 * PUTAVL UPDATES THE DIS SECTOR.
1233                 *
1234                 *   ENTRY: NONE
1235                 *   EXIT:  CS IF ERROR
1236                 *          REGISTERS CHANGED
1237                 
1238 D950 BDD78F     PUTAVL    JSR      FSECMP    FIND SECTOR MAP
1239 D953 8DEA                 BSR      GETDIS    GO GET DIS
1240 D955 25F8                 BCS      GETDI2    ERROR?
1241 D957 C606                 LDB      #6        SET UP COUNTER
1242 D959 10BED40B             LDY      FCBSTR    GET FCB POINTER
1243 D95D BED41B               LDX      AVLPNT    POINT TO MAP
1244                 
1245 D960 A680       PUTAV2    LDA      0,X+
1246 D962 A7A85D               STA      FSB+FSA+IRS-4,Y
1247 D965 3121                 LEAY     1,Y
1248 D967 5A                   DECB               DEC THE COUNT
1249 D968 26F6                 BNE      PUTAV2    FINISHED?
1250                 
1251 D96A BDD6A7               JSR      WRITSS    WRITE SECTOR
1252 D96D 24E0                 BCC      GETDI2    ERROR?
1253 D96F 7EDBD8               JMP      WRTERR    REPORT ERROR
1254                 
1255                 * WRTDIR
1256                 *
1257                 * WRTDIR UPDATES THE DISK DIRECTORY.
1258                 *
1259                 *   ENTRY: NONE
1260                 *   EXIT:  CS IF ERROR
1261                 
1262 D972 BED40B     WRTDIR    LDX      FCBSTR    POINT TO FCB
1263 D975 8602                 LDA      #2        SET FOR WRITE
1264 D977 A702                 STA      FAS,X
1265 D979 EC882F               LDD      FCD,X     GET CURRENT DIR
1266 D97C ED881E               STD      FCS,X     SET CURRENT SECTOR
1267 D97F BDD649               JSR      READSS    READ IN DIR
1268 D982 2508                 BCS      WRTDI2    ERROR?
1269 D984 BDD87F               JSR      PUTIR     GO WRITE DIR
1270 D987 2405                 BCC      WRTDI4
1271 D989 7EDBD8               JMP      WRTERR    CHECK FOR WP ERR
1272                 
1273 D98C C60A       WRTDI2    LDB      #WTER     SET ERROR
1274 D98E 39         WRTDI4    RTS                ERROR RETURN
1275                 
1276                 * OPNRD
1277                 *
1278                 * OPNRD IS THE HIGH LEVEL SYSTEM
1279                 * ROUTINE WHICH OPENS A FILE FOR
1280                 * A READ OPERATION.
1281                 *
1282                 *   ENTRY: NONE
1283                 *   EXIT:  CS IF ERROR (IN B)
1284                 *          REGISTERS CHANGED
1285                 
1286 D98F BDD4FE     OPNRD     JSR      SETFCB    SET FCB POINTER
1287 D992 253D                 BCS      OPNRD2    ERROR?
1288 D994 BDD89B               JSR      FNDNAM    LOOK UP NAME
1289 D997 2538                 BCS      OPNRD2    ERRORS?
1290                 
1291 D999 263B                 BNE      LD9D6     WAS IT FOUND?
1292                 
1293 D99B BED40B               LDX      FCBSTR    POINT TO FCB
1294 D99E 7DD41A               TST      SINDIR    SINGLE DIR?
1295 D9A1 2706                 BEQ      OPNRD1
1296 D9A3 A60F                 LDA      FID,X     CHECK RP BIT
1297 D9A5 8520                 BITA     #$20      IS IT SET?
1298 D9A7 2629                 BNE      OPNRD3    REPORT ERROR
1299                 
1300 D9A9 BDDCD8     OPNRD1    JSR      SETMAX    SET MAX SEC
1301 D9AC 252A                 BCS      OPNERR    ERROR?
1302 D9AE EC8811               LDD      FSA,X     GET ADDRESS
1303 D9B1 ED8840               STD      FSB,X     SET FRWD LINK
1304 D9B4 BDDA8D               JSR      SETST     SET STATUS
1305 D9B7 E68817               LDB      FMP,X     CHECK RANDOM
1306 D9BA 2713                 BEQ      OPNR15
1307                 
1308 D9BC 3404       OPNR12    PSHS     B         SAVE COUNT
1309 D9BE BDD614               JSR      RDNEXT    GET NEXT SECTOR
1310 D9C1 3504                 PULS     B         RESTORE COUNT
1311 D9C3 250C                 BCS      OPNRD2    ERROR?
1312                 
1313 D9C5 5A                   DECB               DEC THE COUNT
1314 D9C6 26F4                 BNE      OPNR12
1315                 
1316 D9C8 BED40B               LDX      FCBSTR    SET FCB PNTR
1317 D9CB 5F                   CLRB               GET SECTOR LENGTH \\\\
1318 D9CC E78822               STB      FDI,X
1319                 
1320 D9CF 1CFE       OPNR15    ANDCC    #$FE      CLC CLEAR ERRORS
1321 D9D1 39         OPNRD2    RTS
1322                 
1323 D9D2 C611       OPNRD3    LDB      #ADER     READ ACC DENIED
1324 D9D4 2002                 BRA      OPNERR
1325                 
1326 D9D6 C604       LD9D6     LDB      #NFER     FILE NOT FOUND
1327                 
1328                 * OPEN ERROR
1329                 
1330 D9D8 3404       OPNERR    PSHS     B         SAVE ERROR
1331 D9DA BDD510               JSR      REMFCB    REMOVE FCB
1332 D9DD 3504                 PULS     B
1333 D9DF 1A01                 ORCC     #1        SEC  SET ERROR
1334 D9E1 39                   RTS
1335                 
1336                 * OPNWT
1337                 *
1338                 * OPNWT OPENS A FILE FOR WRITE.
1339                 *
1340                 *   ENTRY: NONE
1341                 *   EXIT:  CS IF ERROR (IN B)
1342                 *          REGISTERS CHANGED
1343                 
1344 D9E2 BED40B     OPNWT     LDX      FCBSTR    SET POINTER
1345 D9E5 6D03                 TST      FDN,X     CHECK FOR ALL DRIVES
1346 D9E7 2A08                 BPL      OPNWT3
1347 D9E9 BDDDD5               JSR      NXTRDY    FIND READY
1348 D9EC 2403                 BCC      OPNWT3    FOUND ONE
1349 D9EE C610                 LDB      #NRER     NONE READY
1350 D9F0 39                   RTS
1351                 
1352 D9F1 BDD4FE     OPNWT3    JSR      SETFCB    SET FCB LINK
1353 D9F4 25E2                 BCS      OPNERR    ERROR?
1354 D9F6 BDD53B               JSR      CLRFCB    CLEAR OUT FCB
1355 D9F9 BDD920               JSR      GETAVL    SETUP SECTOR MAP
1356 D9FC 25DA                 BCS      OPNERR    ERROR?
1357 D9FE BDD89B               JSR      FNDNAM    GO LOOK FOR NAME
1358 DA01 25D5                 BCS      OPNERR    ERROR?
1359 DA03 2604                 BNE      OPNWT4    FIND?
1360 DA05 C603                 LDB      #FEER     FOUND - ERROR
1361 DA07 20CF                 BRA      OPNERR
1362                 
1363 DA09 BDDCD8     OPNWT4    JSR      SETMAX    SET MAX SEC
1364 DA0C 25CA                 BCS      OPNERR    ERROR?
1365 DA0E BED40B               LDX      FCBSTR    POINT TO FCB
1366 DA11 C60A                 LDB      #10       SET COUNT
1367 DA13 6F0F       OPNWT5    CLR      FID,X     CLEAR BLOCK
1368 DA15 3001                 LEAX     1,X
1369 DA17 5A                   DECB               DEC THE COUNT
1370 DA18 26F9                 BNE      OPNWT5
1371                 
1372 DA1A BED40B               LDX      FCBSTR
1373 DA1D EC8832               LDD      FFD,X     GET FIRST DELETED
1374 DA20 2734                 BEQ      OPNWT8    EOF ER?
1375 DA22 ED882F               STD      FCD,X     SET CURRENT DIR
1376 DA25 A68834               LDA      FFD+2,X   GET INDEX
1377 DA28 A78831               STA      FCD+2,X   SAVE IT
1378 DA2B FCCC0E               LDD      DATE      GET DATE
1379 DA2E ED8819               STD      FDT,X     SET DATE
1380 DA31 B6CC10               LDA      DATE+2
1381 DA34 A7881B               STA      FDT+2,X
1382                 
1383                 *       -- Not in UniFLEX version
1384                 
1385 DA37 A603                 LDA      FDN,X     GET DRIVE
1386 DA39 8ED436               LDX      #DRVINFO  GET TABLE POINTER
1387 DA3C A686                 LDA      A,X       GET DRIVE INFO
1388 DA3E BED40B               LDX      FCBSTR    POINT TO FCB
1389 DA41 A78818               STA      24,X
1390                 
1391                 *       --
1392                 
1393 DA44 BDDDC5               JSR      RSTNAM    RESTORE NAME
1394 DA47 BDD972               JSR      WRTDIR    SET DIRECTORY
1395 DA4A 258C                 BCS      OPNERR    ERROR?
1396 DA4C 8D3F                 BSR      SETST     SET STATUS
1397 DA4E 8604                 LDA      #RS       SET DATA POINTER
1398 DA50 A78822               STA      FDI,X
1399 DA53 1CFE                 ANDCC    #$FE      CLC CLEAR ERRORS
1400 DA55 39                   RTS
1401                 
1402 DA56 BED40B     OPNWT8    LDX      FCBSTR    POINT TO FCB
1403 DA59 6F8817               CLR      FMP,X     CLEAR FLAG
1404 DA5C 6C8812               INC      FSA+1,X   SET FSA NON 0
1405 DA5F EC882F               LDD      FCD,X     GET POSITION
1406 DA62 BDD628               JSR      RDNEX2    READ SECTOR
1407 DA65 250D                 BCS      OPNW85    ERROR?
1408                 
1409 DA67 BDD77A               JSR      WTNEX1    GO WRITE NEW
1410 DA6A 2508                 BCS      OPNW85    ERROR?
1411                 
1412 DA6C BDD6A7               JSR      WRITSS    WRITE NEW SECTOR
1413 DA6F 2406                 BCC      OPNWT9    ERROR?
1414 DA71 BDDBD8               JSR      WRTERR    REPORT ERROR
1415                 
1416 DA74 7ED9D8     OPNW85    JMP      OPNERR
1417                 
1418 DA77 BED40B     OPNWT9    LDX      FCBSTR    SET POINTER
1419 DA7A EC881E               LDD      FCS,X     GET CURRENT
1420 DA7D ED8832               STD      FFD,X     SET FIRST DELETED
1421 DA80 8610                 LDA      #IRS      SET INDEX
1422 DA82 A78834               STA      FFD+2,X
1423 DA85 BDD950               JSR      PUTAVL    UPDATE AVLS
1424 DA88 25EA                 BCS      OPNW85
1425 DA8A 7EDA09               JMP      OPNWT4    FINISH UP
1426                 
1427                 * SETST
1428                 *
1429                 * SETST SETS THE FCB STATUS AFTER
1430                 * AN OPEN FILE COMMAND.
1431                 *
1432                 *   ENTRY: NONE
1433                 *   EXIT:  A & X CHANGED
1434                 
1435 DA8D BED40B     SETST     LDX      FCBSTR    POINT TO FCB
1436 DA90 A684                 LDA      FFC,X     GET FUNCTION CODE
1437 DA92 A702                 STA      FAS,X     SET ACTIVITY STATUS
1438 DA94 6F84                 CLR      FFC,X     CLEAR FUNCTION CODE
1439 DA96 6F883B               CLR      FSC,X     CLEAR SPC COMP
1440 DA99 4F                   CLRA               GET SECTOR LENGTH \\\\
1441 DA9A A78822               STA      FDI,X     SET INDEX
1442 DA9D 39                   RTS
1443                 
1444                 * NEXTS
1445                 *
1446                 * NEXTS IS THE SYSTEM ROUTINE TO
1447                 * ADVANCE TO THE NEXT SECTOR.
1448                 *
1449                 *   ENTRY: NONE
1450                 *   EXIT:  ALL CHANGED
1451                 
1452 DA9E 8D28       NEXTS     BSR      DOSTAT    CHECK STATUS
1453 DAA0 250E                 BCS      NEXTS4    ERROR?
1454 DAA2 6F84                 CLR      0,X
1455 DAA4 44                   LSRA               READING?
1456 DAA5 1025FB6B             LBCS     RDNEXT    READ NEXT
1457                 
1458 DAA9 C604                 LDB      #RS       SET START
1459 DAAB E78822               STB      FDI,X     SET INDEX
1460 DAAE 1CFE                 ANDCC    #$FE      CLC CLEAR ERRORS
1461 DAB0 39         NEXTS4    RTS
1462                 
1463                 * CHKWT
1464                 *
1465                 * CHECK FOR WRITE SECTOR NECESSITY
1466                 *
1467                 *   ENTRY: NONE
1468                 *   EXIT:  CS IF ERROR
1469                 
1470 DAB1 BED40B     CHKWT     LDX      FCBSTR    GET FCB POINTER
1471 DAB4 A602                 LDA      FAS,X     GET STATUS
1472 DAB6 8183                 CMPA     #$83      NEED WRITING?
1473 DAB8 260B                 BNE      CHKWT4
1474                 
1475 DABA 8603                 LDA      #3        RESET STATUS
1476 DABC A702                 STA      FAS,X
1477                 
1478 DABE BDD6A7     CHKWT2    JSR      WRITSS    WRITE SECTOR
1479 DAC1 10250113             LBCS     WRTERR    REPORT ERROR
1480                 
1481 DAC5 1CFE       CHKWT4    ANDCC    #$FE      CLC CLEAR ERRORS
1482 DAC7 39                   RTS
1483                 
1484                 * DOSTAT
1485                 *
1486                 * DOSTAT DOES FILE STATUS CHECKING
1487                 *
1488                 *   ENTRY: NONE
1489                 *   EXIT:  ALL CHANGED
1490                 *          CS IF ERROR
1491                 
1492 DAC8 8DE7       DOSTAT    BSR      CHKWT     CHECK FOR WRITE
1493 DACA 250D                 BCS      DOSTA4    ERRORS?
1494                 
1495 DACC BED40B               LDX      FCBSTR    SET POINTER
1496 DACF A602                 LDA      FAS,X     GET STATUS
1497 DAD1 8103                 CMPA     #3        IS IT RW?
1498 DAD3 23F0                 BLS      CHKWT4    ERROR?
1499                 
1500 DAD5 C612                 LDB      #STER     SET ERROR
1501 DAD7 1A01                 ORCC     #1        SEC
1502 DAD9 39         DOSTA4    RTS                ERROR RETURN
1503                 
1504                 * CLOSE
1505                 *
1506                 * CLOSE A DISK FILE
1507                 *
1508                 *   ENTRY: NONE
1509                 *   EXIT:  ALL CHANGED
1510                 
1511 DADA 8DEC       CLOSE     BSR      DOSTAT    CHECK STATUS
1512 DADC 2531                 BCS      CLOSE4    ERROR?
1513 DADE 8102                 CMPA     #2        IS IT WRITE?
1514 DAE0 2708                 BEQ      CLOSE2
1515                 
1516 DAE2 BED40B     CLOSE1    LDX      FCBSTR    GET FCB
1517 DAE5 6F02                 CLR      FAS,X     CLEAR STATUS
1518 DAE7 7ED510               JMP      REMFCB    REMOVE FCB
1519                 
1520 DAEA A68812     CLOSE2    LDA      FSA+1,X   CHECK IF EMPTY
1521 DAED 2605                 BNE      CLOSE3    EMPTY?
1522 DAEF BDDBBE               JSR      DELNAM    DELETE NAME
1523 DAF2 2019                 BRA      CLOS35
1524                 
1525 DAF4 8DC8       CLOSE3    BSR      CHKWT2    WRITE SECTOR
1526 DAF6 2517                 BCS      CLOSE4    ERROR?
1527 DAF8 BED40B               LDX      FCBSTR    GET POINTER
1528 DAFB 6D8817               TST      FMP,X     RANDOM?
1529 DAFE 2705                 BEQ      CLOS32
1530                 
1531 DB00 BDDCAF               JSR      WTFSM     WRITE FSM
1532 DB03 250A                 BCS      CLOSE4    ERROR?
1533                 
1534 DB05 BDD972     CLOS32    JSR      WRTDIR    WRITE DIRECTORY
1535 DB08 2505                 BCS      CLOSE4    ERROR?
1536                 
1537 DB0A BDD950               JSR      PUTAVL    SET AVL MAP
1538                 
1539 DB0D 24D3       CLOS35    BCC      CLOSE1    ERRORS?
1540 DB0F 39         CLOSE4    RTS                ERROR RETURN
1541                 
1542                 * OPNRW
1543                 *
1544                 * OPNRW OPENS A FILE FOR UPDATE
1545                 *
1546                 *   ENTRY: NONE
1547                 *   EXIT:  CS IF ERROR
1548                 
1549 DB10 BDD98F     OPNRW     JSR      OPNRD     OPEN AS READ
1550 DB13 2528                 BCS      WTAPP4    ERROR?
1551 DB15 BDD614               JSR      RDNEXT    READ FIRST SEC
1552 DB18 2523                 BCS      WTAPP4    ERRORS?
1553                 
1554 DB1A 8603                 LDA      #3        SET RW STATUS
1555 DB1C 2018                 BRA      WTAPP2    FINISH UP
1556                 
1557                 * WTAPP
1558                 *
1559                 * WTAPP IS THE SYSTEM OPEN FILE
1560                 * FOR WRITE APPEND. THE FILE MUST
1561                 * EXIST AND NEW DATA IS WRITTEN ON
1562                 * THE END OF THE FILE.
1563                 *
1564                 *   ENTRY: NONE
1565                 *   EXIT:  CS IF ERROR
1566                 
1567 DB1E BDD98F     WTAPP     JSR      OPNRD     OPEN AS READ
1568 DB21 251A                 BCS      WTAPP4    ERRORS?
1569                 
1570 DB23 BED40B               LDX      FCBSTR    GET FCB POINTER
1571 DB26 A60F                 LDA      FID,X     GET ATT BYTE
1572 DB28 8580                 BITA     #$80      CHECK WP BIT
1573 DB2A 2612                 BNE      WTAPP6
1574                 
1575 DB2C EC8813               LDD      FEA,X     GET END ADDRESS
1576 DB2F BDD628               JSR      RDNEX2    READ IN LAST
1577 DB32 2509                 BCS      WTAPP4    ERRORS?
1578                 
1579 DB34 8602                 LDA      #2        SET WRITE STATUS
1580                 
1581 DB36 BED40B     WTAPP2    LDX      FCBSTR    SET POINTER
1582 DB39 A702                 STA      FAS,X     SET STATUS
1583 DB3B 1CFE                 ANDCC    #$FE      CLC CLEAR ERRORS
1584 DB3D 39         WTAPP4    RTS
1585                 
1586 DB3E C60B       WTAPP6    LDB      #WPER     SET ERROR
1587 DB40 1A01                 ORCC     #1        SEC
1588 DB42 39                   RTS
1589                 
1590                 * RENAME
1591                 *
1592                 * RENAME IS THE SYSTEM FILE RENAME
1593                 * ROUTINE.  THE NEW NAME MUST BE IN
1594                 * FCB+FLR.
1595                 *
1596                 *   ENTRY: SEE ABOVE
1597                 *   EXIT:  CS IF ERROR
1598                 
1599 DB43 8D35       RENAME    BSR      SWAP      SWAP NAMES
1600 DB45 BDD89B               JSR      FNDNAM    GO LOOK FOR IT
1601 DB48 252A                 BCS      RENAM5    ERROR?
1602 DB4A 2724                 BEQ      RENAM4    ALREADY EXISTS?
1603                 
1604 DB4C BED40B               LDX      FCBSTR
1605 DB4F C60B                 LDB      #NL       SET COUNTER
1606                 
1607 DB51 A68824     RENAM1    LDA      FWB,X     GET CHAR
1608 DB54 A704                 STA      FFN,X     MOVE BACK
1609 DB56 3001                 LEAX     1,X       BUMP THE POINTER
1610 DB58 5A                   DECB               DEC THE COUNT
1611 DB59 26F6                 BNE      RENAM1
1612 DB5B 8D4D                 BSR      SWPNM     SWAP AND FIND
1613 DB5D 2515                 BCS      RENAM5    ERROR?
1614 DB5F BED40B               LDX      FCBSTR    GET POINTER
1615 DB62 A60F                 LDA      FID,X     GET ATT BYTE
1616 DB64 8580                 BITA     #$80
1617 DB66 26D6                 BNE      WTAPP6
1618 DB68 8560                 BITA     #$60      CHECK DP BIT
1619 DB6A 2609                 BNE      RENAM6
1620 DB6C 8D0C                 BSR      SWAP      SWAP NAMES
1621 DB6E 2055                 BRA      DELNA2    WRITE DIRECTORY
1622                 
1623 DB70 C603       RENAM4    LDB      #FEER     SET ERROR
1624 DB72 1A01                 ORCC     #1        SEC SHOW ERROR
1625 DB74 39         RENAM5    RTS
1626                 
1627 DB75 C60C       RENAM6    LDB      #DPER     SET ERROR
1628 DB77 1A01                 ORCC     #1        SEC SHOW ERROR
1629 DB79 39                   RTS
1630                 
1631                 * SWAP
1632                 *
1633                 * SWAP THE NAME IN FLR WITH FFN.
1634                 * IF FLR HAS NULL EXT SET AS FFN.
1635                 
1636 DB7A BED40B     SWAP      LDX      FCBSTR    SET FCB POINTER
1637 DB7D 860B                 LDA      #NL       SET COUNT
1638 DB7F B7D411               STA      ETRIES    SAVE IT
1639                 
1640 DB82 A604       SWAP2     LDA      FFN,X     GET CHARACTER
1641 DB84 E68835               LDB      FLR,X     GET OTHER
1642 DB87 A78835               STA      FLR,X     SWAP THEM
1643 DB8A E704                 STB      FFN,X
1644 DB8C 3001                 LEAX     1,X       BUMP TO NEXT
1645 DB8E 7AD411               DEC      ETRIES    DEC THE COUNT
1646 DB91 26EF                 BNE      SWAP2     AGAIN?
1647                 
1648 DB93 BED40B               LDX      FCBSTR    RESTORE POINTER
1649 DB96 A60C                 LDA      FNE,X     GET IST CHAR
1650 DB98 260C                 BNE      SWAP6     IS IT NULL?
1651 DB9A C603                 LDB      #3        SET COUNT
1652 DB9C A6883D     SWAP4     LDA      FLR+8,X   GET CHAR
1653 DB9F A70C                 STA      FNE,X     SAVE IT
1654 DBA1 3001                 LEAX     1,X       BUMP TO NEXT
1655 DBA3 5A                   DECB               DEC THE COUNT
1656 DBA4 26F6                 BNE      SWAP4
1657 DBA6 BED40B     SWAP6     LDX      FCBSTR    RESTORE POINTER
1658 DBA9 39                   RTS
1659                 
1660                 * SWPNM
1661                 *
1662                 * SWAP NAMES AND DO FNDNAM
1663                 
1664 DBAA 8DCE       SWPNM     BSR      SWAP      GO DO SWAP
1665 DBAC BDD89B     SWPNM2    JSR      FNDNAM    FIND NAME
1666 DBAF 2507                 BCS      SWPNM4    ERROR?
1667 DBB1 2606                 BNE      SWPNM5    NO FIND?
1668                 
1669 DBB3 BED40B               LDX      FCBSTR    RESTORE POINTER
1670 DBB6 1CFE                 ANDCC    #$FE      CLC CLEAR ERRORS
1671 DBB8 39         SWPNM4    RTS
1672                 
1673 DBB9 C604       SWPNM5    LDB      #NFER     SET ERROR
1674 DBBB 1A01                 ORCC     #1        SEC
1675 DBBD 39                   RTS
1676                 
1677                 * DELNAM
1678                 *
1679                 * DELETE FILE NAME IN DIR
1680                 
1681 DBBE BED40B     DELNAM    LDX      FCBSTR    POINT TO FCB
1682 DBC1 86FF                 LDA      #$FF      SET NEGATIVE
1683 DBC3 A704                 STA      FFN,X     SET VALUE
1684                 
1685 DBC5 BDD972     DELNA2    JSR      WRTDIR    WRITE DIRECTORY
1686 DBC8 BED40B               LDX      FCBSTR    SET POINTER
1687 DBCB 8600                 LDA      #0        CLEAR STATUS
1688 DBCD A702                 STA      FAS,X
1689 DBCF 39                   RTS
1690                 
1691                 * WRITIT
1692                 *
1693                 * WRITIT PUTS AND WRITES NEW
1694                 * FORWARD LINK IN SECTOR.
1695                 
1696 DBD0 ED8840     WRITIT    STD      FSB,X     SET NEW LINK
1697 DBD3 BDD6A7               JSR      WRITSS    WRITE SECTOR
1698 DBD6 2414                 BCC      WRTER4
1699                 
1700 DBD8 C540       WRTERR    BITB     #$40      W.P. ?
1701 DBDA 2608                 BNE      WRTER1
1702 DBDC C580                 BITB     #$80
1703 DBDE 270A                 BEQ      WRTER3
1704 DBE0 C610                 LDB      #NRER     SET NOT READY
1705 DBE2 2006                 BRA      WRTER3
1706                 
1707 DBE4 C60B       WRTER1    LDB      #WPER     SET WP ERROR
1708 DBE6 2002                 BRA      WRTER3
1709                 
1710                 * ---- No path to this code
1711                 
1712 DBE8 C60A       WRTER2    LDB      #WTER     SET WRITE ERROR
1713                 
1714                 * ----
1715                 
1716 DBEA 1A01       WRTER3    ORCC     #1
1717 DBEC 39         WRTER4    RTS
1718                 
1719                 * DELETE
1720                 *
1721                 * DELETE A SYSTEM FILE RETURNING ITS
1722                 * SECTORS BACK TO THE LIST OF AVAIL.
1723                 *
1724                 *   ENTRY: NAME IN FFN
1725                 *   EXIT:  ALL CHANGED
1726                 *          CS IF ERROR
1727                 
1728 DBED BDD920     DELETE    JSR      GETAVL    GET SEC MAP
1729 DBF0 255E                 BCS      DELET6    ERROR?
1730 DBF2 8DB8                 BSR      SWPNM2    FIND NAME
1731 DBF4 255A                 BCS      DELET6    ERROR?
1732                 
1733 DBF6 BED40B               LDX      FCBSTR    GET POINTER
1734 DBF9 A60F                 LDA      FID,X     GET ATT BYTE
1735 DBFB 8580                 BITA     #$80      CHECK WP BIT
1736 DBFD 2652                 BNE      DELET7
1737                 
1738 DBFF 8560                 BITA     #$60      CHECK DP BIT
1739 DC01 2652                 BNE      DELET8
1740                 
1741 DC03 BDD78F               JSR      FSECMP    FIND SEC MAP
1742 DC06 BED41B               LDX      AVLPNT    GET MAP POINTER
1743 DC09 EC02                 LDD      2,X       GET LAST AVAIL
1744 DC0B 260F                 BNE      DELET2    IS IT NULL?
1745 DC0D BED40B               LDX      FCBSTR    RESTORE POINTER
1746 DC10 EC8811               LDD      FSA,X     GET START ADR
1747 DC13 2733                 BEQ      DELET5
1748 DC15 BED41B               LDX      AVLPNT    POINT TO AVAILS
1749 DC18 ED84                 STD      0,X       SET NEW
1750 DC1A 2014                 BRA      DELET4    JUMP AHEAD
1751                 
1752 DC1C BED40B     DELET2    LDX      FCBSTR    SET POINTER
1753 DC1F BDD628               JSR      RDNEX2    READ SECTOR
1754 DC22 252C                 BCS      DELET6    ERRORS?
1755 DC24 BED40B               LDX      FCBSTR    RESTORE POINTER
1756 DC27 EC8811               LDD      FSA,X     GET START ADR
1757 DC2A 271C                 BEQ      DELET5
1758 DC2C 8DA2                 BSR      WRITIT    SET LINK
1759 DC2E 2520                 BCS      DELET6    ERROR?
1760                 
1761 DC30 BED40B     DELET4    LDX      FCBSTR    SET FCB PNTR
1762 DC33 EC8813               LDD      FEA,X     GET END ADR
1763 DC36 BED41B               LDX      AVLPNT    POINT TO AVAILS
1764 DC39 ED02                 STD      2,X       SET NEW LAST
1765 DC3B BED40B               LDX      FCBSTR    SET POINTER
1766 DC3E EC8815               LDD      FSZ,X     GET SIZE
1767 DC41 BED41B               LDX      AVLPNT    POINT TO AVAILS
1768 DC44 E304                 ADDD     4,X       ADD IN SECTORS
1769 DC46 ED04                 STD      4,X       SAVE NEW COUNT
1770                 
1771 DC48 BDDBBE     DELET5    JSR      DELNAM    DELETE NAME
1772 DC4B 2503                 BCS      DELET6    ERROR?
1773 DC4D BDD950               JSR      PUTAVL    WRITE AVAIL SEC
1774 DC50 39         DELET6    RTS
1775                 
1776 DC51 C60B       DELET7    LDB      #WPER     SET ERROR
1777 DC53 2002                 BRA      DELET9
1778                 
1779 DC55 C60C       DELET8    LDB      #DPER     SET ERROR
1780 DC57 1A01       DELET9    ORCC     #1        SEC SHOW ERROR
1781 DC59 39                   RTS
1782                 
1783                 * UPDFSM
1784                 *
1785                 * UPDATE FILE SECTOR MAP
1786                 
1787 DC5A EC881E     UPDFSM    LDD      FCS,X     GET CURRENT SEC
1788 DC5D 5C                   INCB               CHECK       IF SEQUENTIAL
1789 DC5E E1883C               CMPB     FMX,X     CHECK MAX
1790 DC61 2303                 BLS      UPDFS2
1791 DC63 C601                 LDB      #1        SET SECTOR 1
1792 DC65 4C                   INCA               BUMP TRACK
1793 DC66 10A38813   UPDFS2    CMPD     FEA,X     CHECK END
1794 DC6A 260E                 BNE      UPDFS4
1795 DC6C A68837               LDA      SBC,X     CHECK MAX COUNT
1796 DC6F 81FF                 CMPA     #$FF      IS IT MAX?
1797 DC71 2707                 BEQ      UPDFS4
1798 DC73 4C                   INCA               BUMP COUNT
1799 DC74 A78837               STAA     SBC,X     SAVE IT
1800 DC77 1CFE                 CLC                CLEAR ERRORS
1801 DC79 39                   RTS                RETURN
1802                 
1803 DC7A 8D33       UPDFS4    BSR      WTFSM     WRITE FSM
1804 DC7C 2530                 BCS      UPDFS9    ERROR?
1805 DC7E BED40B               LDX      FCBSTR    SET POINTER
1806 DC81 A6883A               LDA      FNK+2,X   GET OFFSET
1807 DC84 8B03                 ADDA     #3        BUMP TO NEXT ENTRY
1808 DC86 2616                 BNE      UPDFS8    END OF SECTOR?
1809 DC88 EC881E               LDD      FCS,X     GET CURRENT
1810 DC8B 10A38811             CMPD     FSA,X     START ADDR?
1811 DC8F 2705                 BEQ      UPDFS7
1812 DC91 C617       UPDFS6    LDB      #FSER     SET ERROR
1813 DC93 1A01                 SEC
1814 DC95 39                   RTS                RETURN
1815                 
1816 DC96 EC8840     UPDFS7    LDD      FSB,X     GET LINK
1817 DC99 ED8838     UPDF75    STD      FNK,X     SET POINTER
1818 DC9C 8604                 LDA      #4        SET INITIAL OFFSET
1819 DC9E A7883A     UPDFS8    STAA     FNK+2,X
1820 DCA1 EC8813               LDD      FEA,X     GET END ADDR
1821 DCA4 ED8835               STD      FLR,X     MARK POSITION
1822 DCA7 8601                 LDA      #1        SET COUNT
1823 DCA9 A78837               STAA     SBC,X
1824 DCAC 1CFE                 CLC                CLEAR ERRORS
1825 DCAE 39         UPDFS9    RTS                RETURN
1826                 
1827                 * WTFSM
1828                 *
1829                 * WRITE FILE SECTOR MAP
1830                 
1831 DCAF EC8838     WTFSM     LDD      FNK,X     GET RECORD
1832 DCB2 BDD628               JSR      RDNEX2    READ SECTOR
1833 DCB5 25F7                 BCS      UPDFS9    ERROR?
1834 DCB7 BED40B               LDX      FCBSTR
1835 DCBA 1F12                 TFR      X,Y
1836 DCBC E6883A               LDB      FNK+2,X
1837                 
1838                 * LEAX    B,X   < original code
1839                 * Add NOP and ABX
1840                 
1841 DCBF 12                   NOP
1842 DCC0 3A                   ABX                CORRECTED 2/4/80
1843 DCC1 C603                 LDB      #3
1844 DCC3 A6A835     WTFSM2    LDA      FLR,Y
1845 DCC6 3121                 LEAY     1,Y
1846 DCC8 A78840               STA      FSB,X
1847 DCCB 3001                 LEAX     1,X
1848 DCCD 5A                   DECB               DEC THE COUNT
1849 DCCE 26F3                 BNE      WTFSM2
1850 DCD0 BDD6A7               JSR      WRITSS    WRITE SECTOR
1851 DCD3 24D9                 BCC      UPDFS9    ERROR?
1852 DCD5 7EDBD8               JMP      WRTERR    SET ERROR
1853                 
1854                 * SETMAX
1855                 *
1856                 * SET MAX SECTOR NUMBER
1857                 
1858 DCD8 BDD818     SETMAX    JSR      OPNSIR    GET SECTOR
1859 DCDB BDD614               JSR      RDNEXT
1860 DCDE 2546                 BCS      POSI05    ERROR?
1861 DCE0 BED40B               LDX      FCBSTR    SET FCB PNTR
1862 DCE3 4F                   CLRA
1863 DCE4 5F                   CLRB
1864 DCE5 ED8820               STD      FRN,X     CLEAR REC NUM
1865 DCE8 A68867               LDA      FSB+39,X  GET MAX
1866 DCEB A7883C               STAA     FMX,X     SAVE MAX
1867 DCEE 5F                   CLRB               GET SECTOR LENGTH \\\\
1868 DCEF 6F8840     SETMA2    CLR      FSB,X     CLEAR BYTES
1869 DCF2 3001                 LEAX     1,X
1870 DCF4 5A                   DECB               DEC THE COUNTER
1871 DCF5 26F8                 BNE      SETMA2
1872 DCF7 BED40B               LDX      FCBSTR    RESTORE POINTER
1873 DCFA 1CFE                 CLC                CLEAR ERRORS
1874 DCFC 39                   RTS                RETURN
1875                 
1876                 * BKREC
1877                 *
1878                 * BACK UP ONE RECORD
1879                 
1880 DCFD BED40B     BKREC     LDX      FCBSTR    GET FCB
1881 DD00 A68817               LDA      FMP,X     RANDOM?
1882 DD03 271D                 BEQ      POSIT0
1883 DD05 EC8820               LDD      FRN,X     GET REC NUMBER
1884 DD08 830001               SUBD     #1        DEC BY ONE
1885 DD0B 2A03                 BPL      BKREC2    UNDERFLOW?
1886 DD0D 7EDDB2               JMP      POSIT8
1887 DD10 ED8820     BKREC2    STD      FRN,X     SAVE NEW
1888                 
1889                 * POSIT
1890                 *
1891                 * POSITION TO FRN RECORD NUMBER
1892                 
1893 DD13 BDDAC8     POSIT     JSR      DOSTAT    CHECK STATUS
1894 DD16 250E                 BCS      POSI05    ERROR?
1895 DD18 46                   RORA
1896 DD19 2407                 BCC      POSIT0    ERROR?
1897 DD1B 6F84                 CLR      0,X       CLEAR FFC
1898 DD1D A68817               LDA      FMP,X     CHECK RANDOM
1899 DD20 2605                 BNE      POSIT1    ERROR?
1900                 
1901 DD22 C612       POSIT0    LDB      #STER     SET ERROR
1902 DD24 1A01                 SEC
1903 DD26 39         POSI05    RTS                RETURN
1904                 
1905 DD27 7FD411     POSIT1    CLR      ETRIES    CLEAR COUNT
1906 DD2A EC8811               LDD      FSA,X     GET START ADDR
1907 DD2D 10AE8820             LDY      FRN,X     CHECK FOR 0
1908 DD31 276A                 BEQ      POSIT7    GO DO ZERO
1909 DD33 BDDDB7     POSIT2    JSR      GETFSM    GET FSM
1910 DD36 25EE                 BCS      POSI05
1911 DD38 4F                   CLRA               CLEAR COUNT
1912 DD39 5F                   CLRB
1913 DD3A 6D02       POSIT3    TST      2,X       CHECK FOR EOF
1914 DD3C 2774                 BEQ      POSIT8
1915 DD3E EB02                 ADDB     2,X       ADD IN NEW
1916 DD40 8900                 ADCA     #0
1917 DD42 BFD40F               STX      DATAPT
1918 DD45 BED40B               LDX      FCBSTR
1919 DD48 10A38820             CMPD     FRN,X     CHECK NUMBER
1920 DD4C 242C                 BHS      POSIT6
1921 DD4E BED40F     POSIT4    LDX      DATAPT    RESTORE POINTER
1922 DD51 3003                 LEAX     3,X       BUMP TO NEXT
1923 DD53 3402                 PSHS     A         SAVE COUNT
1924 DD55 B6D411               LDA      ETRIES
1925 DD58 4C                   INCA               BUMP POSITION
1926 DD59 B7D411               STA      ETRIES    SAVE RESULT
1927 DD5C 8154                 CMPA     #84       LAST RECORD?
1928 DD5E 2708                 BEQ      POSIT5
1929 DD60 81A8                 CMPA     #168
1930 DD62 3502                 PULS     A         RESTORE TOTAL
1931 DD64 274C                 BEQ      POSIT8    ERROR?
1932 DD66 20D2                 BRA      POSIT3    REPEAT
1933 DD68 3404       POSIT5    PSHS     B
1934 DD6A BED40B               LDX      FCBSTR    SET POINTER
1935 DD6D EC8840               LDD      FSB,X
1936 DD70 8D45                 BSR      GETFSM    GET FSM
1937 DD72 253E                 BCS      POSIT8    ERROR?
1938 DD74 3504                 PULS     B
1939 DD76 3502                 PULS     A         RESTORE TOTAL
1940 DD78 20C0                 BRA      POSIT3    REPEAT
1941 DD7A A38820     POSIT6    SUBD     FRN,X     SUB REC NUM
1942 DD7D BED40F               LDX      DATAPT    RESTORE POINTER
1943 DD80 A602                 LDA      2,X
1944 DD82 3404A0E0             SBA
1945 DD86 4A                   DECA               FIX UP COUNT
1946 DD87 1F89                 TFR      A,B
1947 DD89 A684                 LDA      0,X       GET TRACK
1948 DD8B EB01                 ADDB     1,X       ADD IN SECTOR
1949 DD8D BED40B               LDX      FCBSTR
1950 DD90 2505                 BCS      POSI68
1951 DD92 E1883C     POSI65    CMPB     FMX,X     MAX?
1952 DD95 2306                 BLS      POSIT7
1953 DD97 E0883C     POSI68    SUBB     FMX,X     FIX IF SO
1954 DD9A 4C                   INCA               BUMP TRACK
1955 DD9B 20F5                 BRA      POSI65
1956 DD9D BDD628     POSIT7    JSR      RDNEX2    READ NEXT
1957 DDA0 2514                 BCS      POSI85    ERROR?
1958 DDA2 BED40B               LDX      FCBSTR
1959 DDA5 EC8842               LDD      FSB+2,X   GET LRN
1960 DDA8 10A38820             CMPD     FRN,X     COMPARE TO FRN
1961 DDAC 2714                 BEQ      GETS1
1962 DDAE C619       POSI75    LDB      #RMER     SET ERROR
1963 DDB0 2002                 BRA      POSI82
1964 DDB2 C618       POSIT8    LDB      #RRER     SET ERROR
1965 DDB4 1A01       POSI82    SEC
1966 DDB6 39         POSI85    RTS                RETURN
1967                 
1968                 * GET FSM SECTOR
1969                 
1970 DDB7 BDD628     GETFSM    JSR      RDNEX2    READ NEXT SEC
1971 DDBA 2508                 BCS      GETS2     ERROR?
1972 DDBC BED40B               LDX      FCBSTR    SET INDEX
1973 DDBF C644                 LDB      #FSB+4    SET OFFSET
1974 DDC1 3A                   ABX
1975 DDC2 1CFE       GETS1     CLC                CLEAR ERRORS
1976 DDC4 39         GETS2     RTS
1977                 
1978                 * RSTNAM
1979                 *
1980                 * RESTORE NAME FROM FWB TO FFN.
1981                 
1982 DDC5 BED40B     RSTNAM    LDX      FCBSTR    SET FCB
1983 DDC8 C60B                 LDB      #NL       SET COUNTER
1984 DDCA A68824     RSTNA2    LDA      FWB,X     GET CHARACTER
1985 DDCD A704                 STA      FFN,X     PUT IT
1986 DDCF 3001                 INX                BUMP THE POINTER
1987 DDD1 5A                   DECB               DEC THE COUNT
1988 DDD2 26F6                 BNE      RSTNA2
1989 DDD4 39                   RTS                RETURN
1990                 
1991                 * NXTRDY
1992                 *
1993                 * NXTRDY RETURNS THE DRIVE NUMBER IN
1994                 * FCB+FDN OF THE NEXT READY DRIVE.
1995                 * CS IF NO MORE READY DRIVES.
1996                 
1997 DDD5 BED40B     NXTRDY    LDX      FCBSTR    GET FCB
1998 DDD8 A603                 LDA      FDN,X     GET DRIVE NUMBER
1999 DDDA 4C                   INCA               BUMP BY ONE
2000 DDDB 8104                 CMPA     #4        PAST RANGE?
2001 DDDD 240F                 BHS      NXTRD6
2002 DDDF A703                 STA      FDN,X     SAVE NEW NUMBER
2003 DDE1 2605                 BNE      NXTRD2    DRIVE 0 ?
2004 DDE3 BDDE0F               JSR      CHECK     CHECK IF READY
2005 DDE6 2003                 BRA      NXTRD4
2006 DDE8 BDDE12     NXTRD2    JSR      QUKCHK    QUICK CHECK
2007 DDEB 25E8       NXTRD4    BCS      NXTRDY    CHECK NEXT DRIVE
2008 DDED 39                   RTS                RETURN
2009 DDEE C610       NXTRD6    LDB      #NRER     SET ERROR
2010 DDF0 1A01                 SEC
2011 DDF2 39                   RTS                RETURN
2012                 
2013 DDF3                      END


Symbol Table:

PUTNXT           D585 : RDER             0009 : RMER             0019 : 
NL               000B : RRER             0018 : GETIR            D840 : 
CMND5            D4BC : PUTRA2           D5B4 : PUTRA4           D5B7 : 
INIT4            D455 : FMSCLS           D403 : SWAP2            DB82 : 
RENAM1           DB51 : LSTSEC           000F : RENAM4           DB70 : 
RENAM5           DB74 : RENAM6           DB75 : GETIR1           D85B : 
GETIR2           D866 : GETIR4           D86E : PUTRAN           D598 : 
MAXSP            007F : GETIR8           D87E : RENAME           DB43 : 
FSB              0040 : FWB              0024 : OPNR12           D9BC : 
OPNR15           D9CF : CLER             0016 : WRTER1           DBE4 : 
WRTER2           DBE8 : WTNEX1           D77A : WRTER3           DBEA : 
WRTER4           DBEC : FLR              0035 : DELC             0018 : 
WRTERR           DBD8 : WTNEXT           D753 : DINIT            DE15 : 
FSZ              0015 : DATE             CC0E : DRVINFO          D436 : 
STER             0012 : READS2           D653 : READS4           D65D : 
READS6           D665 : PR1              CCFC : READSS           D649 : 
NXTRD2           DDE8 : NXTRD4           DDEB : NXTRD6           DDEE : 
OPNDIR           D825 : RDSEQ            D5FD : GETFS2           D78E : 
OPNSIR           D818 : FFC              0000 : PUTIR            D87F : 
NXTRDY           DDD5 : FSC              003B : GETFSM           DDB7 : 
GETFST           D78A : ASNN85           D803 : VERIFY           DE06 : 
RDSEQ0           D608 : RDSEQ1           D60F : BKREC            DCFD : 
PUTIR2           D88A : FNK              0038 : CLOSE            DADA : 
DAER             000E : DSEC             0005 : DFER             0007 : 
DNER             000F : DPER             000C : FAS              0002 : 
DRER             0005 : FCS              001E : FES              0001 : 
BKREC2           DD10 : FMS              D406 : CLOSE1           DAE2 : 
CLOSE2           DAEA : CLOSE3           DAF4 : CLOSE4           DB0F : 
CMND             D47F : SECMAP           D41D : TMER             0006 : 
OPNIR            D82D : CMND7            D4C8 : ASNNX1           D7A7 : 
ASNNX2           D7AA : RSTNA2           DDCA : ASNNX4           D7B8 : 
ASNNX6           D7C0 : ASNNX7           D7EF : ASNNX8           D7F7 : 
ASNNX9           D804 : TEMP             D40D : SWAP4            DB9C : 
CLRLRN           D746 : FMSINT           D400 : RSTNAM           DDC5 : 
ASNNXT           D7A1 : FCD              002F : CLRTRY           D670 : 
FFD              0032 : POSIT            DD13 : FID              000F : 
OPNERR           D9D8 : REWIN2           D5F8 : RETRY            D678 : 
POSIT0           DD22 : POSIT1           DD27 : POSIT2           DD33 : 
POSIT3           DD3A : POSIT4           DD4E : POSIT5           DD68 : 
POSIT6           DD7A : POSIT7           DD9D : POSIT8           DDB2 : 
REWIND           D5EA : UPDF75           DC99 : EFER             0008 : 
FDT              0019 : RETRY2           D68D : RETRY4           D6A1 : 
RETRY6           D6A4 : CLRFC2           D544 : CLRFCB           D53B : 
DOSTA4           DAD9 : FSECMP           D78F : NODR             0004 : 
INIT             D43A : DOSTAT           DAC8 : WTAPP            DB1E : 
SETMA2           DCEF : CMND8            D4CA : DATAPT           D40F : 
WTAPP2           DB36 : WTAPP4           DB3D : SWPNM            DBAA : 
WTAPP6           DB3E : SETMAX           DCD8 : FNE              000C : 
SWPNM2           DBAC : SWPNM4           DBB8 : GETCUR           D666 : 
SWPNM5           DBB9 : FCBBAS           D409 : RDNEX1           D622 : 
RDNEX2           D628 : RDNEX3           D640 : RDNEX4           D644 : 
RDNEX6           D646 : RDNEX8           D648 : CODTBL           D4D2 : 
DELNA2           DBC5 : RDNEXT           D614 : FBER             0002 : 
FEER             0003 : DELNAM           DBBE : FIER             0014 : 
FSER             0017 : FNU              0010 : POSI65           DD92 : 
POSI68           DD97 : OPNRD            D98F : NFER             0004 : 
NOER             0000 : NRER             0010 : CMND1            D487 : 
OPNRD1           D9A9 : OPNRD2           D9D1 : OPNRD3           D9D2 : 
FNDN04           D8B3 : FNDN06           D8C4 : FNDN08           D8CE : 
RS               0004 : CMND15           D49D : OPNCLD           D825 : 
OPNWT            D9E2 : SWAP6            DBA6 : GETAV2           D932 : 
GETAV3           D93C : GETAV4           D93E : WRITIT           DBD0 : 
NEXTS            DA9E : GETAVL           D920 : OPNWT3           D9F1 : 
OPNWT4           DA09 : OPNWT5           DA13 : OPNWT8           DA56 : 
OPNWT9           DA77 : DRIVE            DE0C : DWARM            DE18 : 
FDN              0003 : FFN              0004 : MAIND            0005 : 
NEXTS4           DAB0 : FRN              0020 : IRFAS            0004 : 
LD9D6            D9D6 : IRS              0010 : POSI75           DDAE : 
CHKWT            DAB1 : REMFC2           D519 : SWAP             DB7A : 
CMND2            D4AB : REMFCB           D510 : CHKWT2           DABE : 
CHKWT4           DAC5 : WTFSM            DCAF : WPER             000B : 
SL               0100 : WTER             000A : SETFC2           D507 : 
VRFYFG           D435 : SETFCB           D4FE : WTFSM2           DCC3 : 
SINDIR           D41A : DWRITE           DE03 : STRIES           D412 : 
CHECK            DE0F : OPNCUD           D81F : FNDNA1           D8DC : 
FNDNA2           D8E8 : FNDNA3           D8F3 : FNDNA4           D8F4 : 
FNDNA6           D8FF : FNDNA8           D907 : FNDNA9           D909 : 
LSTTRK           004C : FNDNAM           D89B : PUTAV2           D960 : 
IRL              0018 : RSC              0007 : RTC              0005 : 
POSI05           DD26 : EXCLS            D45D : PUTAVL           D950 : 
LSTFC            0016 : POSI82           DDB4 : POSI85           DDB6 : 
EXCLS1           D460 : SETFD            D90E : SCMSK            007F : 
AVLPNT           D41B : CMND3            D4B0 : INIT2            D450 : 
SETFD2           D91F : GETS1            DDC2 : RNFMSK           0010 : 
SETST            DA8D : WTSEQ            D71C : DSEEK            DE1B : 
WRITS2           D6B1 : WRITS4           D6C5 : WRITS6           D6D1 : 
WRITS7           D6D2 : WRITS8           D6D4 : ADER             0011 : 
SBC              0037 : SCC              0009 : WRITSS           D6A7 : 
WTSEQ2           D736 : WTSEQ4           D745 : FLP              001C : 
FMP              0017 : SPC              0020 : FSP              003C : 
CMPNA1           D562 : COPNA2           D552 : CMPNA4           D576 : 
ICER             0001 : ISEC             0003 : IFER             000D : 
BKLN             D418 : INER             0015 : CMPNAM           D55D : 
COPNAM           D54D : IRER             0013 : DIRDN            D417 : 
FMX              003C : SRDSE2           D5CA : SRDSE6           D5E4 : 
SRDSE7           D5E7 : SRDSE8           D5E9 : GETRAN           D577 : 
DTRK             0000 : FCBSTR           D40B : GETDI2           D94F : 
DELET2           DC1C : DELET4           DC30 : ETRIES           D411 : 
DELET5           DC48 : DELET6           DC50 : DELET7           DC51 : 
DELET8           DC55 : DELET9           DC57 : SRDSEQ           D5BC : 
CMND4            D4B4 : DELETE           DBED : TRMSK            007F : 
GETDIS           D93F : QUKCHK           DE12 : UNLOCK           C70C : 
FEA              0013 : UPDFS2           DC66 : UPDFS4           DC7A : 
UPDFS6           DC91 : UPDFS7           DC96 : UPDFS8           DC9E : 
DREAD            DE00 : CLD              D413 : UPDFS9           DCAE : 
OPNRW            DB10 : GETS2            DDC4 : FSA              0011 : 
CUD              D415 : SWTSE2           D6ED : CLOS32           DB05 : 
SWTSE4           D6F2 : CLOS35           DB0D : SWTSE6           D6F7 : 
ASNN65           D7D0 : UPDFSM           DC5A : FDI              0022 : 
WRTDI2           D98C : SWTSEQ           D6D7 : WRTDI4           D98E : 
FNDFC3           D529 : FNDFC4           D531 : FRI              0023 : 
FNDFC6           D537 : PUTSP2           D704 : PUTSP4           D714 : 
PUTSP6           D71B : FNDFCB           D520 : WRTDIR           D972 : 
RESTOR           DE09 : PUTSPC           D6FA : OPNW85           DA74 : 
LOCK             C709 : 
